// Tencent is pleased to support the open source community by making
// 蓝鲸智云 - 监控平台 (BlueKing - Monitor) available.
// Copyright (C) 2022 THL A29 Limited, a Tencent company. All rights reserved.
// Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License.
// You may obtain a copy of the License at http://opensource.org/licenses/MIT
// Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
// an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
// specific language governing permissions and limitations under the License.

package v1beta1

import (
	"context"
	"fmt"
	"sync"
	"testing"
	"time"

	"github.com/dominikbraun/graph"
	"github.com/stretchr/testify/assert"

	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/cmdb"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/influxdb"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/internal/query"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/log"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/metadata"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/mock"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/tsdb/prometheus"
)

// BenchmarkGraphQuery_New 测试创建 GraphQuery 的性能
func BenchmarkGraphQuery_New(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	for i := 0; i < b.N; i++ {
		_ = graph.New(graph.IntHash, graph.Directed())
	}
}

// BenchmarkGraphQuery_BuildSmallGraph 测试构建小规模图的性能
func BenchmarkGraphQuery_BuildSmallGraph(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	for i := 0; i < b.N; i++ {
		g := graph.New(graph.IntHash, graph.Directed())
		// 构建包含10个节点的小图
		for j := 0; j < 10; j++ {
			_ = g.AddVertex(j)
		}

		// 添加一些边
		for j := 0; j < 9; j++ {
			_ = g.AddEdge(j, j+1)
		}
	}
}

// BenchmarkGraphQuery_BuildMediumGraph 测试构建中等规模图的性能
func BenchmarkGraphQuery_BuildMediumGraph(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	for i := 0; i < b.N; i++ {
		g := graph.New(graph.IntHash, graph.Directed())
		// 构建包含100个节点的中等图
		for j := 0; j < 100; j++ {
			_ = g.AddVertex(j)
		}

		// 添加边，形成链式结构
		for j := 0; j < 99; j++ {
			_ = g.AddEdge(j, j+1)
		}
	}
}

// BenchmarkGraphQuery_BuildLargeGraph 测试构建大规模图的性能
func BenchmarkGraphQuery_BuildLargeGraph(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	b.StopTimer()

	// 预先生成节点和边数据，避免在计时中包含数据生成时间
	nodes := make([]int, 1000)
	for i := 0; i < 1000; i++ {
		nodes[i] = i
	}

	b.StartTimer()

	for i := 0; i < b.N; i++ {
		g := graph.New(graph.IntHash, graph.Directed())
		// 构建包含1000个节点的大图
		for _, node := range nodes {
			_ = g.AddVertex(node)
		}

		// 添加边，形成链式结构
		for j := 0; j < 999; j++ {
			_ = g.AddEdge(nodes[i], nodes[i+1])
		}
	}
}

// BenchmarkGraphQuery_Traversal 测试图遍历的性能
func BenchmarkGraphQuery_Traversal(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	// 先构建一个测试图
	g := graph.New(graph.IntHash, graph.Directed())

	// 构建包含50个节点的图
	nodes := make([]int, 50)
	for i := 0; i < 50; i++ {
		nodes[i] = i
		_ = g.AddVertex(nodes[i])
	}

	// 添加边，形成链式结构
	for i := 0; i < 49; i++ {
		_ = g.AddEdge(nodes[i], nodes[i+1])
	}

	b.ResetTimer()

	for i := 0; i < b.N; i++ {
		// 测试图的遍历性能
		_, _ = g.Order()
		_, _ = g.Size()
	}
}

// BenchmarkGraphQuery_BuildClusterRelation 测试构建集群关系图的性能
func BenchmarkGraphQuery_BuildClusterRelation(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	b.StopTimer()

	// 预先生成节点和边数据，避免在计时中包含数据生成时间

	nodes := make([]int, 1000)
	for i := 0; i < 1000; i++ {
		nodes[i] = i
	}

	b.StartTimer()

	for i := 0; i < b.N; i++ {
		g := graph.New(graph.IntHash, graph.Directed())

		// 构建包含1000个节点的大图
		for _, node := range nodes {
			_ = g.AddVertex(node)
		}

		// 添加边，形成链式结构
		for j := 0; j < 999; j++ {
			_ = g.AddEdge(nodes[j], nodes[j+1])
		}
	}
}

func BenchmarkGraphQuery_MakeRelationData(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	b.StopTimer()

	spaceUID := influxdb.SpaceUid
	start := time.Unix(1763636985, 0)
	end := time.Unix(1763640585, 0)
	step := time.Minute * 5
	info := map[string]string{
		"namespace": "blueking",
	}
	relations := []cmdb.Relation{
		{V: []cmdb.Resource{"pod", "container"}},
		{V: []cmdb.Resource{"node", "pod"}},
		{V: []cmdb.Resource{"node", "system"}},
	}

	ctx := metadata.InitHashID(context.Background())
	mock.Init()
	influxdb.MockSpaceRouter(ctx)

	mock.Vm.Set(map[string]any{
		`query_range:17636369851763640585300count by (bcs_cluster_id, container, namespace, pod) (count_over_time(a[5m]))`: `{"result":true,"message":"成功","code":"00","data":{"list":[{"status":"success","isPartial":false,"data":{"resultType":"matrix","result":[{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-513-hgh8l"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-514-bmr4h"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-516-zplkg"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-517-m69hs"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-523-hm6jx"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-543-zvmcn"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-544-cfxp4"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-545-bcqsm"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-546-ndvr5"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-557-bkj92"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-559-tcs9k"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-563-h655n"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-583-mxspg"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-c56d97548-2xzlz"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-c56d97548-58cw4"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-c56d97548-frcln"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-c56d97548-sqt75"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-153-927sh"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-158-htbkd"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-159-q6pt6"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-6f57fbbb5f-4d485"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-6f57fbbb5f-grntp"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-6f57fbbb5f-l6qkb"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-6f57fbbb5f-sb6m4"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-api-7c4c9559c8-8g64x"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-api-7c4c9559c8-plzlx"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]}]}}]}}`,
		`query_range:17636369851763640585300count by (bcs_cluster_id, namespace, node, pod) (count_over_time(a[5m]))`:      `{"result":true,"message":"成功","code":"00","data":{"list":[{"status":"success","isPartial":false,"data":{"resultType":"matrix","result":[{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.2","pod":"bk-datalink-unify-query-apigw-sync-583-mxspg"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.3","pod":"bk-datalink-unify-query-c56d97548-frcln"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.89","pod":"bk-datalink-unify-query-apigw-sync-544-cfxp4"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.204","pod":"bk-datalink-unify-query-apigw-sync-517-m69hs"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.211","pod":"bk-datalink-unify-query-apigw-sync-513-hgh8l"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.211","pod":"bk-datalink-unify-query-apigw-sync-514-bmr4h"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.168","pod":"bk-datalink-unify-query-c56d97548-2xzlz"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.111","pod":"bk-datalink-unify-query-c56d97548-58cw4"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.121","pod":"bk-datalink-unify-query-apigw-sync-559-tcs9k"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.50","pod":"bk-datalink-unify-query-apigw-sync-563-h655n"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.152","pod":"bk-datalink-unify-query-apigw-sync-543-zvmcn"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.152","pod":"bk-datalink-unify-query-apigw-sync-545-bcqsm"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.211","pod":"bk-datalink-unify-query-apigw-sync-523-hm6jx"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.68","pod":"bk-datalink-unify-query-apigw-sync-546-ndvr5"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.184","pod":"bk-datalink-unify-query-apigw-sync-516-zplkg"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.19","pod":"bk-datalink-unify-query-apigw-sync-557-bkj92"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.37","pod":"bk-datalink-unify-query-c56d97548-sqt75"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]}]}}]}}`,
		`query_range:17636369851763640585300count by (bcs_cluster_id, bk_target_ip, node) (count_over_time(a[5m]))`:        `{"result":true,"message":"成功","code":"00","data":{"list":[{"status":"success","isPartial":false,"data":{"resultType":"matrix","result":[{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.229","node":"master-127.0.0.229"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.41","node":"master-127.0.0.41"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.90","node":"master-127.0.0.90"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.188","node":"127.0.0.188"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.212","node":"127.0.0.212"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.218","node":"127.0.0.218"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.127","node":"127.0.0.127"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.25","node":"127.0.0.25"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.103","node":"127.0.0.103"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.125","node":"127.0.0.125"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.133","node":"127.0.0.133"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.2","node":"127.0.0.2"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.51","node":"127.0.0.51"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.61","node":"127.0.0.61"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.78","node":"127.0.0.78"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.82","node":"127.0.0.82"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.84","node":"127.0.0.84"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.94","node":"127.0.0.94"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.105","node":"127.0.0.105"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.118","node":"127.0.0.118"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.123","node":"127.0.0.123"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.126","node":"127.0.0.126"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.50","node":"127.0.0.50"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.53","node":"127.0.0.53"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.56","node":"127.0.0.56"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.61","node":"127.0.0.61"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.65","node":"127.0.0.65"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.83","node":"127.0.0.83"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.3","node":"127.0.0.3"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.89","node":"127.0.0.89"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.4","node":"127.0.0.4"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.55","node":"127.0.0.55"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.5","node":"127.0.0.5"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.204","node":"127.0.0.204"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.211","node":"127.0.0.211"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.212","node":"127.0.0.212"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.226","node":"127.0.0.226"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.212","node":"127.0.0.212"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.66","node":"127.0.0.66"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.88","node":"127.0.0.88"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.168","node":"127.0.0.168"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.225","node":"127.0.0.225"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.226","node":"127.0.0.226"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.111","node":"127.0.0.111"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.121","node":"127.0.0.121"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.50","node":"127.0.0.50"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.102","node":"127.0.0.102"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.152","node":"127.0.0.152"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.87","node":"127.0.0.87"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.78","node":"127.0.0.78"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.238","node":"127.0.0.238"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.171","node":"127.0.0.171"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.174","node":"127.0.0.174"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.211","node":"127.0.0.211"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.68","node":"127.0.0.68"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.207","node":"127.0.0.207"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.189","node":"127.0.0.189"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.69","node":"127.0.0.69"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.184","node":"127.0.0.184"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.19","node":"127.0.0.19"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.37","node":"127.0.0.37"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.75","node":"127.0.0.75"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.249","node":"127.0.0.249"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.215","node":"127.0.0.215"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.141","node":"127.0.0.141"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.1","node":"127.0.0.1"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]}]}}]}}`,
	})

	b.StartTimer()
	for i := 0; i < b.N; i++ {
		tg := NewTimeGraph()

		ins := prometheus.GetTsDbInstance(ctx, &metadata.Query{
			StorageID:   metadata.VictoriaMetricsStorageType,
			StorageType: metadata.VictoriaMetricsStorageType,
		})

		for _, relation := range relations {
			ctx = metadata.InitHashID(ctx)

			queryTs, err := tg.MakeQueryTs(ctx, spaceUID, info, start, end, step, relation)
			if err != nil {
				log.Fatalf(ctx, err.Error())
			}

			queryRef, err := queryTs.ToQueryReference(ctx)
			if err != nil {
				log.Fatalf(ctx, err.Error())
			}
			metadata.SetExpand(ctx, query.ToVmExpand(ctx, queryRef))

			expr, err := queryTs.ToPromExpr(ctx, nil)
			if err != nil {
				log.Fatalf(ctx, err.Error())
			}
			stmt := expr.String()
			res, _, err := ins.DirectQueryRange(ctx, stmt, start, end, step)
			if err != nil {
				log.Fatalf(ctx, err.Error())
			}

			for _, series := range res {
				info := make(map[string]string, len(series.Metric))
				for _, m := range series.Metric {
					info[m.Name] = m.Value
				}

				timestamps := make([]int64, 0, len(series.Points))
				for _, point := range series.Points {
					timestamps = append(timestamps, point.T)
				}
				err = tg.AddTimeRelation(ctx, relation.V[0], relation.V[1], info, timestamps...)
				if err != nil {
					log.Fatalf(ctx, err.Error())
				}
			}

			log.Infof(ctx, "%s", tg.Stat())
		}
	}
}

func TestTimeGraph_MakeQueryTs(t *testing.T) {
	spaceUID := "test-space"

	testCases := map[string]struct {
		labels    map[string]string
		relations []cmdb.Relation
		expected  []string
	}{
		"test create query ts with relations": {
			labels: map[string]string{
				"namespace": "blueking",
			},
			relations: []cmdb.Relation{
				{V: []cmdb.Resource{"pod", "container"}},
				{V: []cmdb.Resource{"node", "pod"}},
				{V: []cmdb.Resource{"node", "system"}},
			},
			expected: []string{
				`count by (bcs_cluster_id, container, namespace, pod) (count_over_time(bkmonitor:container_with_pod_relation{bcs_cluster_id!="",container!="",namespace="blueking",pod!=""}[5m]))`,
				`count by (bcs_cluster_id, namespace, node, pod) (count_over_time(bkmonitor:node_with_pod_relation{bcs_cluster_id!="",namespace="blueking",node!="",pod!=""}[5m]))`,
				`count by (bcs_cluster_id, bk_target_ip, node) (count_over_time(bkmonitor:node_with_system_relation{bcs_cluster_id!="",bk_target_ip!="",node!=""}[5m]))`,
			},
		},
	}

	start := time.Unix(1763636985, 0)
	end := time.Unix(1763640585, 0)
	step := time.Minute * 5

	ctx := metadata.InitHashID(context.Background())
	tg := NewTimeGraph()

	for name, c := range testCases {
		t.Run(name, func(t *testing.T) {
			for i, relation := range c.relations {
				queryTs, err := tg.MakeQueryTs(ctx, spaceUID, c.labels, start, end, step, relation)
				assert.NoError(t, err)

				promql, err := queryTs.ToPromQL(ctx)
				assert.NoError(t, err)
				assert.Equal(t, c.expected[i], promql)
			}
		})
	}
}

func TestTimeGraph_AddTimeRelation(t *testing.T) {
	ctx := context.Background()
	tg := NewTimeGraph()

	t.Run("正常添加时间关系", func(t *testing.T) {
		info := map[string]string{
			"namespace":      "blueking",
			"bcs_cluster_id": "BCS-K8S-00000",
		}
		timestamps := []int64{1763636985, 1763637285, 1763637585}

		err := tg.AddTimeRelation(ctx, "pod", "container", info, timestamps...)
		assert.NoError(t, err)

		nodes := tg.GetNodesByResourceType("pod")
		containers := tg.GetNodesByResourceType("container")

		// 验证节点信息

		assert.Equal(t, info, nodes)
		assert.Equal(t, info, containers)

		// 验证时间图状态
		stat := tg.Stat()
		assert.Contains(t, stat, "节点总数: 2")
		assert.Contains(t, stat, "时序边数: 1763636985: 1")
		assert.Contains(t, stat, "时序边数: 1763637285: 1")
		assert.Contains(t, stat, "时序边数: 1763637585: 1")
	})

	t.Run("info为空时直接返回", func(t *testing.T) {
		emptyInfo := map[string]string{}
		timestamps := []int64{1763636985}

		err := tg.AddTimeRelation(ctx, "node", "pod", emptyInfo, timestamps...)
		assert.NoError(t, err)

		// 验证没有添加任何关系
		stat := tg.Stat()
		// 应该只包含之前测试添加的节点和边
		assert.Contains(t, stat, "节点总数: 2")
	})

	t.Run("边已存在的情况", func(t *testing.T) {
		info := map[string]string{
			"namespace":      "blueking",
			"bcs_cluster_id": "BCS-K8S-00000",
		}
		timestamps := []int64{1763636985} // 使用已存在的时间戳

		// 第一次添加
		err := tg.AddTimeRelation(ctx, "node", "system", info, timestamps...)
		assert.NoError(t, err)

		// 第二次添加相同的边
		err = tg.AddTimeRelation(ctx, "node", "system", info, timestamps...)
		assert.NoError(t, err) // 应该成功，边已存在时不会报错

		stat := tg.Stat()
		assert.Contains(t, stat, "节点总数: 4") // pod, container, node, system
	})

	t.Run("多个时间戳的情况", func(t *testing.T) {
		info := map[string]string{
			"namespace":      "test",
			"bcs_cluster_id": "BCS-K8S-00001",
		}
		// 添加多个连续时间戳
		timestamps := make([]int64, 10)
		for i := range timestamps {
			timestamps[i] = 1763638000 + int64(i*300)
		}

		err := tg.AddTimeRelation(ctx, "service", "pod", info, timestamps...)
		assert.NoError(t, err)

		stat := tg.Stat()
		// 验证所有时间戳都被添加
		for _, ts := range timestamps {
			assert.Contains(t, stat, fmt.Sprintf("时序边数: %d: 1", ts))
		}
	})

	t.Run("并发添加关系", func(t *testing.T) {
		var wg sync.WaitGroup
		errors := make(chan error, 10)

		for i := 0; i < 10; i++ {
			wg.Add(1)
			go func(index int) {
				defer wg.Done()
				info := map[string]string{
					"namespace":      fmt.Sprintf("namespace-%d", index),
					"bcs_cluster_id": fmt.Sprintf("BCS-K8S-%05d", index),
				}
				timestamps := []int64{1763639000 + int64(index)}

				err := tg.AddTimeRelation(ctx, "node", "pod", info, timestamps...)
				if err != nil {
					errors <- err
				}
			}(i)
		}

		wg.Wait()
		close(errors)

		// 检查是否有错误发生
		for err := range errors {
			assert.NoError(t, err)
		}

		// 验证所有关系都被正确添加
		stat := tg.Stat()
		assert.Contains(t, stat, "节点总数: 16") // 初始4个 + 10个并发添加的节点
	})

	t.Run("不同资源类型的关系", func(t *testing.T) {
		testCases := []struct {
			name     string
			source   cmdb.Resource
			target   cmdb.Resource
			info     map[string]string
			expected string
		}{
			{
				name:   "pod到container关系",
				source: "pod",
				target: "container",
				info: map[string]string{
					"namespace": "app1",
				},
			},
			{
				name:   "node到pod关系",
				source: "node",
				target: "pod",
				info: map[string]string{
					"bk_target_ip": "127.0.0.1",
				},
			},
			{
				name:   "service到pod关系",
				source: "service",
				target: "pod",
				info: map[string]string{
					"service_name": "web-service",
				},
			},
		}

		for _, tc := range testCases {
			t.Run(tc.name, func(t *testing.T) {
				timestamps := []int64{1763640000}
				err := tg.AddTimeRelation(ctx, tc.source, tc.target, tc.info, timestamps...)
				assert.NoError(t, err)

				// 验证关系被正确添加
				stat := tg.Stat()
				assert.Contains(t, stat, fmt.Sprintf("时序边数: %d: 1", timestamps[0]))
			})
		}
	})
}
