// Tencent is pleased to support the open source community by making
// 蓝鲸智云 - 监控平台 (BlueKing - Monitor) available.
// Copyright (C) 2022 THL A29 Limited, a Tencent company. All rights reserved.
// Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License.
// You may obtain a copy of the License at http://opensource.org/licenses/MIT
// Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
// an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
// specific language governing permissions and limitations under the License.

package pipeline_test

import (
	"sync"
	"testing"

	"github.com/stretchr/testify/suite"

	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/transfer/define"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/transfer/models"
	_ "github.com/TencentBlueKing/bkmonitor-datalink/pkg/transfer/template/etl"
	_ "github.com/TencentBlueKing/bkmonitor-datalink/pkg/transfer/template/etl/formatter"
	_ "github.com/TencentBlueKing/bkmonitor-datalink/pkg/transfer/template/etl/procperf"
	. "github.com/TencentBlueKing/bkmonitor-datalink/pkg/transfer/testsuite"
)

// ProcPortPipelineSuite :
type ProcPortPipelineSuite struct {
	ETLPipelineSuite
}

// SetupTest :
func (s *ProcPortPipelineSuite) SetupTest() {
	s.ConsulConfig = `{"etl_config":"bk_system_proc","result_table_list":[{"schema_type":"fixed","shipper_list":[{"cluster_config":{"domain_name":"influxdb.service.consul","port":5260},"storage_config":{"real_table_name":"proc","database":"system"},"cluster_type":"influxdb"}],"result_table":"system.proc","field_list":[{"default_value":null,"type":"int","is_config_by_user":true,"tag":"dimension","field_name":"bk_biz_id"},{"default_value":null,"type":"int","is_config_by_user":true,"tag":"dimension","field_name":"bk_cloud_id"},{"default_value":null,"type":"int","is_config_by_user":true,"tag":"dimension","field_name":"bk_supplier_id"},{"default_value":null,"type":"double","is_config_by_user":true,"tag":"metric","field_name":"cpu_usage_pct"},{"default_value":null,"type":"string","is_config_by_user":true,"tag":"dimension","field_name":"display_name"},{"default_value":null,"type":"int","is_config_by_user":true,"tag":"metric","field_name":"fd_num"},{"default_value":null,"type":"string","is_config_by_user":true,"tag":"dimension","field_name":"hostname"},{"default_value":null,"type":"string","is_config_by_user":true,"tag":"dimension","field_name":"ip"},{"default_value":null,"type":"int","is_config_by_user":true,"tag":"metric","field_name":"mem_res"},{"default_value":null,"type":"double","is_config_by_user":true,"tag":"metric","field_name":"mem_usage_pct"},{"default_value":null,"type":"int","is_config_by_user":true,"tag":"metric","field_name":"mem_virt"},{"default_value":null,"type":"string","is_config_by_user":true,"tag":"dimension","field_name":"param_regex"},{"default_value":null,"type":"int","is_config_by_user":true,"tag":"dimension","field_name":"pgid"},{"default_value":null,"type":"int","is_config_by_user":true,"tag":"dimension","field_name":"pid"},{"default_value":null,"type":"int","is_config_by_user":true,"tag":"dimension","field_name":"ppid"},{"default_value":null,"type":"string","is_config_by_user":true,"tag":"dimension","field_name":"proc_name"},{"default_value":null,"type":"string","is_config_by_user":true,"tag":"dimension","field_name":"state"},{"default_value":null,"type":"timestamp","is_config_by_user":true,"tag":"","field_name":"time"},{"default_value":null,"type":"string","is_config_by_user":true,"tag":"dimension","field_name":"username"}]}],"mq_config":{"cluster_config":{"domain_name":"kafka.service.consul","port":9092},"storage_config":{"topic":"0bkmonitor_10070","partition":1},"cluster_type":"kafka"},"data_id":1007}`
	s.PipelineName = "bk_system_proc"
	s.ETLPipelineSuite.SetupTest()
}

// TestRun :
func (s *ProcPortPipelineSuite) TestRun() {
	s.StoreHost(&models.CCHostInfo{
		IP:      "127.0.0.1",
		CloudID: 0,
	}).AnyTimes()
	s.StoreHost(&models.CCHostInfo{
		IP:      "127.0.0.1",
		CloudID: 0,
	}).AnyTimes()

	var wg sync.WaitGroup

	wg.Add(2)
	s.FrontendPulled = `
{"bkmonitorbeat":{"address":["127.0.0.1"],"hostname":"zk-3","name":"zk-3","version":"1.2.10"},"bizid":0,"cloudid":0,"data":{"perf":[{"cpu":{"start_time":"2018-06-07T07:14:39.000Z","total":{"pct":0.060000}},"displayname":"tsdb-proxy","exe":"/usr/bin/tsdb-proxy","exists":true,"fd":{"limit":{"hard":204800,"soft":204800},"open":276},"io":{"read_bytes":4923392,"read_speed":0.000000,"write_bytes":10655363072,"write_speed":68.222050},"memory":{"rss":{"bytes":33660928,"pct":0.000500},"share":3223552,"size":2425651200},"name":"tsdb-proxy","paramregex":"","pgid":24725,"pid":24921,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2018-06-07T04:25:58.000Z","total":{"pct":0.005300}},"displayname":"etcd","exe":"/usr/bin/etcd","exists":true,"fd":{"limit":{"hard":204800,"soft":204800},"open":31},"io":{"read_bytes":2899968,"read_speed":0.000000,"write_bytes":6017024,"write_speed":0.000000},"memory":{"rss":{"bytes":17899520,"pct":0.000300},"share":7675904,"size":10803343360},"name":"etcd","paramregex":"","pgid":75763,"pid":75954,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2018-06-07T04:26:04.000Z","total":{"pct":0.021700}},"displayname":"influxd","exe":"/usr/bin/influxd","exists":true,"fd":{"limit":{"hard":65536,"soft":65536},"open":554},"io":{"read_bytes":6269919232,"read_speed":0.000000,"write_bytes":1160891150336,"write_speed":60851.270984},"memory":{"rss":{"bytes":1715589120,"pct":0.025500},"share":113106944,"size":6357688320},"name":"influxd","paramregex":"","pgid":77427,"pid":77427,"ppid":1,"state":"sleeping","username":"influxdb"},{"cpu":{"start_time":"2019-01-11T09:44:19.000Z","total":{"pct":0.013300}},"displayname":"consul-agent","exe":"/usr/bin/consul","exists":true,"fd":{"limit":{"hard":204800,"soft":204800},"open":23},"io":{"read_bytes":51785728,"read_speed":0.000000,"write_bytes":455901970432,"write_speed":131868.198634},"memory":{"rss":{"bytes":48029696,"pct":0.000700},"share":26017792,"size":122212352},"name":"consul","paramregex":"","pgid":90157,"pid":90157,"ppid":21362,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2018-12-11T09:49:02.000Z","total":{"pct":0.143600}},"displayname":"kafka-java","exe":"/data/bkee/service/java/bin/java","exists":true,"fd":{"limit":{"hard":102400,"soft":102400},"open":1901},"io":{"read_bytes":733990912,"read_speed":0.000000,"write_bytes":385088503808,"write_speed":61670.579450},"memory":{"rss":{"bytes":1362116608,"pct":0.020300},"share":23502848,"size":20079140864},"name":"java","paramregex":"kafkaServer-gc.log","pgid":792082,"pid":793532,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2018-10-24T09:13:02.000Z","total":{"pct":0.004000}},"displayname":"zk-java","exe":"/data/bkee/service/java/bin/java","exists":true,"fd":{"limit":{"hard":102400,"soft":102400},"open":54},"io":{"read_bytes":144265216,"read_speed":0.000000,"write_bytes":151382323200,"write_speed":15349.090661},"memory":{"rss":{"bytes":175534080,"pct":0.002600},"share":12800000,"size":22539898880},"name":"java","paramregex":"org.apache.zookeeper.server.quorum.QuorumPeerMain","pgid":1559496,"pid":1560267,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2019-01-16T03:07:53.000Z","total":{"pct":0.005500}},"displayname":"redis-server","exe":"/usr/local/bin/redis-server","exists":true,"fd":{"limit":{"hard":102400,"soft":102400},"open":14},"io":{"read_bytes":8253440,"read_speed":0.000000,"write_bytes":8192,"write_speed":0.000000},"memory":{"rss":{"bytes":514764800,"pct":0.007700},"share":1191936,"size":2666418176},"name":"redis-server","paramregex":":6379","pgid":2008446,"pid":2008446,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2019-01-16T03:07:53.000Z","total":{"pct":0.001200}},"displayname":"redis-sentinel","exe":"/usr/local/bin/redis-server","exists":true,"fd":{"limit":{"hard":102400,"soft":102400},"open":69},"io":{"read_bytes":53248,"read_speed":0.000000,"write_bytes":4096,"write_speed":0.000000},"memory":{"rss":{"bytes":3067904,"pct":0.000000},"share":1093632,"size":151932928},"name":"redis-server","paramregex":"sentinel","pgid":2008451,"pid":2008451,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2019-01-07T09:50:01.000Z","total":{"pct":0.002500}},"displayname":"ceph-mon","exe":"/usr/bin/ceph-mon","exists":true,"fd":{"limit":{"hard":1048576,"soft":1048576},"open":40},"io":{"read_bytes":198209536,"read_speed":0.000000,"write_bytes":394741362688,"write_speed":353956.975326},"memory":{"rss":{"bytes":208502784,"pct":0.003100},"share":10223616,"size":735846400},"name":"ceph-mon","paramregex":"","pgid":2211484,"pid":2211484,"ppid":1,"state":"sleeping","username":"ceph"},{"cpu":{"start_time":"2019-01-07T09:52:10.000Z","total":{"pct":0.000800}},"displayname":"ceph-radosgw","exe":"/usr/bin/radosgw","exists":true,"fd":{"limit":{"hard":1048576,"soft":1048576},"open":49},"io":{"read_bytes":2199552,"read_speed":0.000000,"write_bytes":512000,"write_speed":0.000000},"memory":{"rss":{"bytes":18288640,"pct":0.000300},"share":5697536,"size":5177921536},"name":"radosgw","paramregex":"","pgid":2221215,"pid":2221215,"ppid":1,"state":"sleeping","username":"ceph"},{"cpu":{"start_time":"2018-12-20T10:18:31.000Z","total":{"pct":0.001300}},"displayname":"redis-sentinel","exe":"/usr/local/bin/redis-server","exists":true,"fd":{"limit":{"hard":102400,"soft":102400},"open":17},"io":{"read_bytes":8192,"read_speed":0.000000,"write_bytes":4096,"write_speed":0.000000},"memory":{"rss":{"bytes":1409024,"pct":0.000000},"share":1073152,"size":149827584},"name":"redis-server","paramregex":"sentinel","pgid":2764125,"pid":2764125,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2019-01-17T03:06:48.000Z","total":{"pct":0.652500}},"displayname":"es-java","exe":"/data/bkee/service/java/bin/java","exists":true,"fd":{"limit":{"hard":204800,"soft":204800},"open":15235},"io":{"read_bytes":138252218368,"read_speed":0.000000,"write_bytes":14235422855168,"write_speed":7071110.522598},"memory":{"rss":{"bytes":19080740864,"pct":0.283700},"share":2908160,"size":84694532096},"name":"java","paramregex":"org.elasticsearch.bootstrap.Elasticsearch","pgid":3538211,"pid":3538284,"ppid":1,"state":"sleeping","username":"es"}]},"dataid":1007,"datetime":"2019-02-22 00:30:03","gseindex":128259,"ip":"127.0.0.1","timezone":8,"type":"processbeat","utctime":"2019-02-21 16:30:03"}
{"bkmonitorbeat":{"address":["127.0.0.1"],"hostname":"zk-3","name":"zk-3","version":"1.2.10"},"bizid":0,"cloudid":0,"data":{"perf":[{"cpu":{"start_time":"2018-06-07T07:14:39.000Z","total":{"pct":0.060000}},"displayname":"tsdb-proxy","exe":"/usr/bin/tsdb-proxy","exists":true,"fd":{"limit":{"hard":204800,"soft":204800},"open":276},"io":{"read_bytes":4923392,"read_speed":0.000000,"write_bytes":10655363072,"write_speed":68.222050},"memory":{"rss":{"bytes":33660928,"pct":0.000500},"share":3223552,"size":2425651200},"name":"tsdb-proxy","paramregex":"","pgid":24725,"pid":24921,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2018-06-07T04:25:58.000Z","total":{"pct":0.005300}},"displayname":"etcd","exe":"/usr/bin/etcd","exists":true,"fd":{"limit":{"hard":204800,"soft":204800},"open":31},"io":{"read_bytes":2899968,"read_speed":0.000000,"write_bytes":6017024,"write_speed":0.000000},"memory":{"rss":{"bytes":17899520,"pct":0.000300},"share":7675904,"size":10803343360},"name":"etcd","paramregex":"","pgid":75763,"pid":75954,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2018-06-07T04:26:04.000Z","total":{"pct":0.021700}},"displayname":"influxd","exe":"/usr/bin/influxd","exists":true,"fd":{"limit":{"hard":65536,"soft":65536},"open":554},"io":{"read_bytes":6269919232,"read_speed":0.000000,"write_bytes":1160891150336,"write_speed":60851.270984},"memory":{"rss":{"bytes":1715589120,"pct":0.025500},"share":113106944,"size":6357688320},"name":"influxd","paramregex":"","pgid":77427,"pid":77427,"ppid":1,"state":"sleeping","username":"influxdb"},{"cpu":{"start_time":"2019-01-11T09:44:19.000Z","total":{"pct":0.013300}},"displayname":"consul-agent","exe":"/usr/bin/consul","exists":true,"fd":{"limit":{"hard":204800,"soft":204800},"open":23},"io":{"read_bytes":51785728,"read_speed":0.000000,"write_bytes":455901970432,"write_speed":131868.198634},"memory":{"rss":{"bytes":48029696,"pct":0.000700},"share":26017792,"size":122212352},"name":"consul","paramregex":"","pgid":90157,"pid":90157,"ppid":21362,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2018-12-11T09:49:02.000Z","total":{"pct":0.143600}},"displayname":"kafka-java","exe":"/data/bkee/service/java/bin/java","exists":true,"fd":{"limit":{"hard":102400,"soft":102400},"open":1901},"io":{"read_bytes":733990912,"read_speed":0.000000,"write_bytes":385088503808,"write_speed":61670.579450},"memory":{"rss":{"bytes":1362116608,"pct":0.020300},"share":23502848,"size":20079140864},"name":"java","paramregex":"kafkaServer-gc.log","pgid":792082,"pid":793532,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2018-10-24T09:13:02.000Z","total":{"pct":0.004000}},"displayname":"zk-java","exe":"/data/bkee/service/java/bin/java","exists":true,"fd":{"limit":{"hard":102400,"soft":102400},"open":54},"io":{"read_bytes":144265216,"read_speed":0.000000,"write_bytes":151382323200,"write_speed":15349.090661},"memory":{"rss":{"bytes":175534080,"pct":0.002600},"share":12800000,"size":22539898880},"name":"java","paramregex":"org.apache.zookeeper.server.quorum.QuorumPeerMain","pgid":1559496,"pid":1560267,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2019-01-16T03:07:53.000Z","total":{"pct":0.005500}},"displayname":"redis-server","exe":"/usr/local/bin/redis-server","exists":true,"fd":{"limit":{"hard":102400,"soft":102400},"open":14},"io":{"read_bytes":8253440,"read_speed":0.000000,"write_bytes":8192,"write_speed":0.000000},"memory":{"rss":{"bytes":514764800,"pct":0.007700},"share":1191936,"size":2666418176},"name":"redis-server","paramregex":":6379","pgid":2008446,"pid":2008446,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2019-01-16T03:07:53.000Z","total":{"pct":0.001200}},"displayname":"redis-sentinel","exe":"/usr/local/bin/redis-server","exists":true,"fd":{"limit":{"hard":102400,"soft":102400},"open":69},"io":{"read_bytes":53248,"read_speed":0.000000,"write_bytes":4096,"write_speed":0.000000},"memory":{"rss":{"bytes":3067904,"pct":0.000000},"share":1093632,"size":151932928},"name":"redis-server","paramregex":"sentinel","pgid":2008451,"pid":2008451,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2019-01-07T09:50:01.000Z","total":{"pct":0.002500}},"displayname":"ceph-mon","exe":"/usr/bin/ceph-mon","exists":true,"fd":{"limit":{"hard":1048576,"soft":1048576},"open":40},"io":{"read_bytes":198209536,"read_speed":0.000000,"write_bytes":394741362688,"write_speed":353956.975326},"memory":{"rss":{"bytes":208502784,"pct":0.003100},"share":10223616,"size":735846400},"name":"ceph-mon","paramregex":"","pgid":2211484,"pid":2211484,"ppid":1,"state":"sleeping","username":"ceph"},{"cpu":{"start_time":"2019-01-07T09:52:10.000Z","total":{"pct":0.000800}},"displayname":"ceph-radosgw","exe":"/usr/bin/radosgw","exists":true,"fd":{"limit":{"hard":1048576,"soft":1048576},"open":49},"io":{"read_bytes":2199552,"read_speed":0.000000,"write_bytes":512000,"write_speed":0.000000},"memory":{"rss":{"bytes":18288640,"pct":0.000300},"share":5697536,"size":5177921536},"name":"radosgw","paramregex":"","pgid":2221215,"pid":2221215,"ppid":1,"state":"sleeping","username":"ceph"},{"cpu":{"start_time":"2018-12-20T10:18:31.000Z","total":{"pct":0.001300}},"displayname":"redis-sentinel","exe":"/usr/local/bin/redis-server","exists":true,"fd":{"limit":{"hard":102400,"soft":102400},"open":17},"io":{"read_bytes":8192,"read_speed":0.000000,"write_bytes":4096,"write_speed":0.000000},"memory":{"rss":{"bytes":1409024,"pct":0.000000},"share":1073152,"size":149827584},"name":"redis-server","paramregex":"sentinel","pgid":2764125,"pid":2764125,"ppid":1,"state":"sleeping","username":"root"},{"cpu":{"start_time":"2019-01-17T03:06:48.000Z","total":{"pct":0.652500}},"displayname":"es-java","exe":"/data/bkee/service/java/bin/java","exists":true,"fd":{"limit":{"hard":204800,"soft":204800},"open":15235},"io":{"read_bytes":138252218368,"read_speed":0.000000,"write_bytes":14235422855168,"write_speed":7071110.522598},"memory":{"rss":{"bytes":19080740864,"pct":0.283700},"share":2908160,"size":84694532096},"name":"java","paramregex":"org.elasticsearch.bootstrap.Elasticsearch","pgid":3538211,"pid":3538284,"ppid":1,"state":"sleeping","username":"es"}]},"dataid":1007,"datetime":"2019-02-22 00:30:03","gseindex":128259,"ip":"127.0.0.1","timezone":8,"type":"processbeat","utctime":"2019-02-21 16:30:03"}
`
	wg.Add(24)
	pipe := s.BuildPipe(func(payload define.Payload) {
		wg.Done()
	}, func(i map[string]interface{}) {
		wg.Done()
	})

	s.RunPipe(pipe, wg.Wait)
}

// TestProcPortPipelineSuite :
func TestProcPortPipelineSuite(t *testing.T) {
	suite.Run(t, new(ProcPortPipelineSuite))
}
