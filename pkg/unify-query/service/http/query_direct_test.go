// Tencent is pleased to support the open source community by making
// 蓝鲸智云 - 监控平台 (BlueKing - Monitor) available.
// Copyright (C) 2022 THL A29 Limited, a Tencent company. All rights reserved.
// Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License.
// You may obtain a copy of the License at http://opensource.org/licenses/MIT
// Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
// an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
// specific language governing permissions and limitations under the License.

package http

import (
	"context"
	"testing"

	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/internal/json"

	"github.com/stretchr/testify/assert"

	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/influxdb"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/metadata"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/mock"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/query/promql"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/query/structured"
)

func TestQueryRawWithInstanceDirect(t *testing.T) {
	ctx := metadata.InitHashID(context.Background())

	spaceUid := influxdb.SpaceUid

	mock.Init()
	influxdb.MockSpaceRouter(ctx)
	promql.MockEngine()

	start := "1723594000"
	end := "1723595000"

	mock.Es.Set(map[string]any{
		// basic query direct test
		`{"from":0,"query":{"bool":{"filter":{"range":{"dtEventTimeStamp":{"format":"epoch_second","from":1723594000,"include_lower":true,"include_upper":true,"to":1723595000}}}}},"size":10}`: `{"took":301,"timed_out":false,"_shards":{"total":3,"successful":3,"skipped":0,"failed":0},"hits":{"total":{"value":10000,"relation":"gte"},"max_score":0.0,"hits":[{"_index":"v2_2_bklog_bk_unify_query_20240814_0","_type":"_doc","_id":"c726c895a380ba1a9df04ba4a977b29b","_score":0.0,"_source":{"dtEventTimeStamp":"1723594161000","__ext":{"container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f"}}},{"_index":"v2_2_bklog_bk_unify_query_20240814_0","_type":"_doc","_id":"f6950fef394e813999d7316cdbf0de4d","_score":0.0,"_source":{"dtEventTimeStamp":"1723594161000","__ext":{"container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f"}}}]}}`,

		`{"from":0,"query":{"bool":{"filter":[{"wildcard":{"message":{"value":"test"}}},{"range":{"dtEventTimeStamp":{"format":"epoch_second","from":1723594000,"include_lower":true,"include_upper":true,"to":1723595000}}}]}},"size":2}`: `{"took":301,"timed_out":false,"_shards":{"total":3,"successful":3,"skipped":0,"failed":0},"hits":{"total":{"value":10000,"relation":"gte"},"max_score":1.0,"hits":[{"_index":"v2_2_bklog_bk_unify_query_20240814_0","_type":"_doc","_id":"c726c895a380ba1a9df04ba4a977b29b","_score":1.0,"_source":{"dtEventTimeStamp":"1723594161000","message":"this is a test message","__ext":{"container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f"}}},{"_index":"v2_2_bklog_bk_unify_query_20240814_0","_type":"_doc","_id":"f6950fef394e813999d7316cdbf0de4d","_score":1.0,"_source":{"dtEventTimeStamp":"1723594161000","message":"another test log entry","__ext":{"container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f"}}}]}}`,

		`{"from":0,"query":{"bool":{"filter":[{"bool":{"must":[{"wildcard":{"message":{"value":"error"}}},{"wildcard":{"__ext.io_kubernetes_pod":{"value":"bk-datalink-unify-query-6df8bcc4c9-rk4sc"}}},{"wildcard":{"__ext.container_name":{"value":"unify-query"}}}]}},{"range":{"dtEventTimeStamp":{"format":"epoch_second","from":1723594000,"include_lower":true,"include_upper":true,"to":1723595000}}},{"term":{"container_name":"unify-query"}}]}},"size":2}`: `{"took":301,"timed_out":false,"_shards":{"total":3,"successful":3,"skipped":0,"failed":0},"hits":{"total":{"value":10000,"relation":"gte"},"max_score":2.0,"hits":[{"_index":"v2_2_bklog_bk_unify_query_20240814_0","_type":"_doc","_id":"c726c895a380ba1a9df04ba4a977b29b","_score":2.0,"_source":{"dtEventTimeStamp":"1723594161000","message":"database connection error occurred","__ext":{"container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f","container_name":"unify-query","io_kubernetes_pod":"bk-datalink-unify-query-6df8bcc4c9-rk4sc"}}},{"_index":"v2_2_bklog_bk_unify_query_20240814_0","_type":"_doc","_id":"f6950fef394e813999d7316cdbf0de4d","_score":2.0,"_source":{"dtEventTimeStamp":"1723594161000","message":"fatal error in processing request","__ext":{"container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f","container_name":"unify-query","io_kubernetes_pod":"bk-datalink-unify-query-6df8bcc4c9-rk4sc"}}}]}}`,
	})

	mock.BkSQL.Set(map[string]any{
		"SHOW CREATE TABLE `2_bklog_bkunify_query_doris`.doris": `{"result":true,"message":"成功","code":"00","data":{"result_table_scan_range":{},"cluster":"doris-test","totalRecords":18,"external_api_call_time_mills":{"bkbase_auth_api":43,"bkbase_meta_api":0,"bkbase_apigw_api":33},"resource_use_summary":{"cpu_time_mills":0,"memory_bytes":0,"processed_bytes":0,"processed_rows":0},"source":"","list":[{"Field":"thedate","Type":"int","Null":"NO","Key":"YES","Default":null,"Extra":""},{"Field":"dteventtimestamp","Type":"bigint","Null":"NO","Key":"YES","Default":null,"Extra":""},{"Field":"dteventtime","Type":"varchar(32)","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"localtime","Type":"varchar(32)","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"__shard_key__","Type":"bigint","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"__ext","Type":"variant","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"cloudid","Type":"double","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"file","Type":"text","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"gseindex","Type":"double","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"iterationindex","Type":"double","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"level","Type":"text","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"log","Type":"text","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"message","Type":"text","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"path","Type":"text","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"report_time","Type":"text","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"serverip","Type":"text","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"time","Type":"text","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"},{"Field":"trace_id","Type":"text","Null":"YES","Key":"NO","Default":null,"Extra":"NONE"}],"stage_elapsed_time_mills":{"check_query_syntax":0,"query_db":5,"get_query_driver":0,"match_query_forbidden_config":0,"convert_query_statement":2,"connect_db":45,"match_query_routing_rule":0,"check_permission":43,"check_query_semantic":0,"pick_valid_storage":1},"select_fields_order":["Field","Type","Null","Key","Default","Extra"],"sql":"SHOW COLUMNS FROM mapleleaf_2.bklog_bkunify_query_doris_2","total_record_size":11776,"timetaken":0.096,"result_schema":[{"field_type":"string","field_name":"Field","field_alias":"Field","field_index":0},{"field_type":"string","field_name":"Type","field_alias":"Type","field_index":1},{"field_type":"string","field_name":"Null","field_alias":"Null","field_index":2},{"field_type":"string","field_name":"Key","field_alias":"Key","field_index":3},{"field_type":"string","field_name":"Default","field_alias":"Default","field_index":4},{"field_type":"string","field_name":"Extra","field_alias":"Extra","field_index":5}],"bksql_call_elapsed_time":0,"device":"doris","result_table_ids":["2_bklog_bkunify_query_doris"]},"errors":null,"trace_id":"00000000000000000000000000000000","span_id":"0000000000000000"}`,

		// doris basic query
		"SELECT *, `dtEventTimeStamp` AS `_value_`, `dtEventTimeStamp` AS `_timestamp_` FROM `2_bklog_bkunify_query_doris`.doris WHERE `dtEventTimeStamp` >= 1723594000000 AND `dtEventTimeStamp` <= 1723595000000 AND `dtEventTime` >= '2024-08-14 08:06:40' AND `dtEventTime` <= '2024-08-14 08:23:21' AND `thedate` = '20240814' LIMIT 10": `{"result":true,"message":"成功","code":"00","data":{"cluster":"codev_doris2","totalRecords":3,"external_api_call_time_mills":{"bkbase_meta_api":10},"resource_use_summary":{"cpu_time_mills":0,"memory_bytes":0,"processed_bytes":0,"processed_rows":0},"source":"","list":[{"dtEventTime":1723594100000,"__shard_key__":29077703950,"dtEventTimeStamp":1723594105000,"thedate":2.0240814e+07,"localtime":"2024-08-14 08:06:40","iterationIndex":15,"__ext":"{\"container_id\":\"abc123def456\",\"container_name\":\"app-server\",\"io_kubernetes_pod\":\"app-server-pod-123\"}","cloudId":0,"gseIndex":2450128,"path":"/var/log/application.log","time":"1723594105","log":"2024-08-14T08:06:40.500Z INFO application started","message":"application started successfully","serverip":"10.0.0.1","trace_id":"info001"},{"dtEventTime":1723594150000,"__shard_key__":29077703951,"dtEventTimeStamp":1723594158000,"thedate":2.0240814e+07,"localtime":"2024-08-14 08:06:41","iterationIndex":17,"__ext":"{\"container_id\":\"def789ghi012\",\"container_name\":\"web-server\",\"io_kubernetes_pod\":\"web-server-pod-456\"}","cloudId":0,"gseIndex":2450129,"path":"/var/log/nginx.log","time":"1723594158","log":"2024-08-14T08:06:41.800Z INFO nginx server running","message":"nginx server is running","serverip":"10.0.0.2","trace_id":"info002"},{"dtEventTime":1723594250000,"__shard_key__":29077703952,"dtEventTimeStamp":1723594252000,"thedate":2.0240814e+07,"localtime":"2024-08-14 08:06:43","iterationIndex":18,"__ext":"{\"container_id\":\"ghi345jkl678\",\"container_name\":\"database\",\"io_kubernetes_pod\":\"database-pod-789\"}","cloudId":0,"gseIndex":2450130,"path":"/var/log/mysql.log","time":"1723594252","log":"2024-08-14T08:06:43.200Z INFO database connected","message":"database connection established","serverip":"10.0.0.3","trace_id":"info003"}],"stage_elapsed_time_mills":{"check_query_syntax":1,"query_db":2000,"get_query_driver":0,"match_query_forbidden_config":0,"convert_query_statement":10,"connect_db":50,"match_query_routing_rule":0,"check_permission":10,"check_query_semantic":0,"pick_valid_storage":1},"select_fields_order":["dtEventTime","__shard_key__","dtEventTimeStamp","thedate","localtime","iterationIndex","__ext","cloudId","gseIndex","path","time","log","message","serverip","trace_id"],"total_record_size":245000,"result_schema":[{"field_type":"long","field_name":"__c0","field_alias":"dtEventTime","field_index":0},{"field_type":"long","field_name":"__c1","field_alias":"__shard_key__","field_index":1},{"field_type":"long","field_name":"__c2","field_alias":"dtEventTimeStamp","field_index":2},{"field_type":"int","field_name":"__c3","field_alias":"thedate","field_index":3},{"field_type":"string","field_name":"__c4","field_alias":"localtime","field_index":4},{"field_type":"long","field_name":"__c5","field_alias":"iterationIndex","field_index":5},{"field_type":"string","field_name":"__c6","field_alias":"__ext","field_index":6},{"field_type":"long","field_name":"__c7","field_alias":"cloudId","field_index":7},{"field_type":"long","field_name":"__c8","field_alias":"gseIndex","field_index":8},{"field_type":"string","field_name":"__c9","field_alias":"path","field_index":9},{"field_type":"long","field_name":"__c10","field_alias":"time","field_index":10},{"field_type":"string","field_name":"__c11","field_alias":"log","field_index":11},{"field_type":"string","field_name":"__c12","field_alias":"message","field_index":12},{"field_type":"string","field_name":"__c13","field_alias":"serverip","field_index":13},{"field_type":"string","field_name":"__c14","field_alias":"trace_id","field_index":14}],"bksql_call_elapsed_time":0,"device":"doris","result_table_ids":["100915_bklog_pub_svrlog_pangusvr_other_other_analysis"]},"errors":null,"trace_id":"0816890bc718ec5786d469e9a79110d2","span_id":"6d04c0ddf758c603"}`,

		// doris complex conditions query
		"SELECT *, `dtEventTimeStamp` AS `_value_`, `dtEventTimeStamp` AS `_timestamp_` FROM `2_bklog_bkunify_query_doris`.doris WHERE `dtEventTimeStamp` >= 1723594000000 AND `dtEventTimeStamp` <= 1723595000000 AND `dtEventTime` >= '2024-08-14 08:06:40' AND `dtEventTime` <= '2024-08-14 08:23:21' AND `thedate` = '20240814' AND (`message` MATCH_PHRASE 'warning' OR `message` MATCH_PHRASE 'critical') AND `serverip` = '10.0.0.1' LIMIT 50": `{"result":true,"message":"成功","code":"00","data":{"cluster":"codev_doris2","totalRecords":2,"external_api_call_time_mills":{"bkbase_meta_api":10},"resource_use_summary":{"cpu_time_mills":0,"memory_bytes":0,"processed_bytes":0,"processed_rows":0},"source":"","list":[{"dtEventTime":1723594300000,"__shard_key__":29077703955,"dtEventTimeStamp":1723594305000,"thedate":2.0240814e+07,"localtime":"2024-08-14 08:06:44","iterationIndex":21,"__ext":"{\"container_id\":\"warning123\",\"container_name\":\"monitor\",\"io_kubernetes_pod\":\"monitor-pod-111\"}","cloudId":0,"gseIndex":2.450133e+06,"path":"/var/log/monitor.log","time":"1723594305","log":"2024-08-14T08:06:44.500Z WARNING high memory usage detected","message":"high memory usage detected on server","serverip":"10.0.0.1","trace_id":"warn001"},{"dtEventTime":1723594350000,"__shard_key__":29077703956,"dtEventTimeStamp":1723594358000,"thedate":2.0240814e+07,"localtime":"2024-08-14 08:06:46","iterationIndex":22,"__ext":"{\"container_id\":\"critical456\",\"container_name\":\"alert-system\",\"io_kubernetes_pod\":\"alert-pod-222\"}","cloudId":0,"gseIndex":2.450134e+06,"path":"/var/log/alert.log","time":"1723594358","log":"2024-08-14T08:06:46.800Z CRITICAL service unavailable","message":"critical service failure detected","serverip":"10.0.0.1","trace_id":"crit001"}],"stage_elapsed_time_mills":{"check_query_syntax":1,"query_db":2500,"get_query_driver":0,"match_query_forbidden_config":0,"convert_query_statement":12,"connect_db":55,"match_query_routing_rule":0,"check_permission":12,"check_query_semantic":0,"pick_valid_storage":1},"select_fields_order":["dtEventTime","__shard_key__","dtEventTimeStamp","thedate","localtime","iterationIndex","__ext","cloudId","gseIndex","path","time","log","message","serverip","trace_id"],"total_record_size":265000,"result_schema":[{"field_type":"long","field_name":"__c0","field_alias":"dtEventTime","field_index":0},{"field_type":"long","field_name":"__c1","field_alias":"__shard_key__","field_index":1},{"field_type":"long","field_name":"__c2","field_alias":"dtEventTimeStamp","field_index":2},{"field_type":"int","field_name":"__c3","field_alias":"thedate","field_index":3},{"field_type":"string","field_name":"__c4","field_alias":"localtime","field_index":4},{"field_type":"long","field_name":"__c5","field_alias":"iterationIndex","field_index":5},{"field_type":"string","field_name":"__c6","field_alias":"__ext","field_index":6},{"field_type":"long","field_name":"__c7","field_alias":"cloudId","field_index":7},{"field_type":"long","field_name":"__c8","field_alias":"gseIndex","field_index":8},{"field_type":"string","field_name":"__c9","field_alias":"path","field_index":9},{"field_type":"long","field_name":"__c10","field_alias":"time","field_index":10},{"field_type":"string","field_name":"__c11","field_alias":"log","field_index":11},{"field_type":"string","field_name":"__c12","field_alias":"message","field_index":12},{"field_type":"string","field_name":"__c13","field_alias":"serverip","field_index":13},{"field_type":"string","field_name":"__c14","field_alias":"trace_id","field_index":14}],"bksql_call_elapsed_time":0,"device":"doris","result_table_ids":["100915_bklog_pub_svrlog_pangusvr_other_other_analysis"]},"errors":null,"trace_id":"0816890bc718ec5786d469e9a79110d2","span_id":"6d04c0ddf758c603"}`,

		// doris highlight test query
		"SELECT *, `dtEventTimeStamp` AS `_value_`, `dtEventTimeStamp` AS `_timestamp_` FROM `2_bklog_bkunify_query_doris`.doris WHERE `dtEventTimeStamp` >= 1723594000000 AND `dtEventTimeStamp` <= 1723595000000 AND `dtEventTime` >= '2024-08-14 08:06:40' AND `dtEventTime` <= '2024-08-14 08:23:21' AND `thedate` = '20240814' AND `message` MATCH_PHRASE 'error' AND `log` MATCH_PHRASE 'error' LIMIT 100": `{"result":true,"message":"成功","code":"00","data":{"cluster":"codev_doris2","totalRecords":2,"external_api_call_time_mills":{"bkbase_meta_api":10},"resource_use_summary":{"cpu_time_mills":0,"memory_bytes":0,"processed_bytes":0,"processed_rows":0},"source":"","list":[{"dtEventTime":1723594160000,"__shard_key__":29077703953,"dtEventTimeStamp":1723594161000,"thedate":2.0240814e+07,"localtime":"2024-08-14 08:06:41","iterationIndex":19,"__ext":"{\"container_id\":\"375597ee636fd5d53cb7b0958823d9ba6534bd24cd698e485c41ca2f01b78ed2\",\"container_name\":\"unify-query\",\"io_kubernetes_pod\":\"bk-datalink-unify-query-6df8bcc4c9-rk4sc\"}","cloudId":0,"gseIndex":2450131,"path":"/var/log/app.log","time":"1723594161","log":"2024-08-14T08:06:41.000Z error database connection failed","message":"database connection error occurred","serverip":"127.0.0.1","trace_id":"abc123"},{"dtEventTime":1723594200000,"__shard_key__":29077703954,"dtEventTimeStamp":1723594201000,"thedate":2.0240814e+07,"localtime":"2024-08-14 08:06:42","iterationIndex":20,"__ext":"{\"container_id\":\"375597ee636fd5d53cb7b0958823d9ba6534bd24cd698e485c41ca2f01b78ed2\",\"container_name\":\"unify-query\",\"io_kubernetes_pod\":\"bk-datalink-unify-query-6df8bcc4c9-rk4sc\"}","cloudId":0,"gseIndex":2450132,"path":"/var/log/app.log","time":"1723594202","log":"2024-08-14T08:06:42.000Z error processing request timeout","message":"fatal error in processing request","serverip":"127.0.0.1","trace_id":"def456"}],"stage_elapsed_time_mills":{"check_query_syntax":1,"query_db":3049,"get_query_driver":0,"match_query_forbidden_config":0,"convert_query_statement":11,"connect_db":66,"match_query_routing_rule":0,"check_permission":11,"check_query_semantic":0,"pick_valid_storage":1},"select_fields_order":["dtEventTime","__shard_key__","dtEventTimeStamp","thedate","localtime","iterationIndex","__ext","cloudId","gseIndex","path","time","log","message","serverip","trace_id"],"total_record_size":327384,"result_schema":[{"field_type":"long","field_name":"__c0","field_alias":"dtEventTime","field_index":0},{"field_type":"long","field_name":"__c1","field_alias":"__shard_key__","field_index":1},{"field_type":"long","field_name":"__c2","field_alias":"dtEventTimeStamp","field_index":2},{"field_type":"int","field_name":"__c3","field_alias":"thedate","field_index":3},{"field_type":"string","field_name":"__c4","field_alias":"localtime","field_index":4},{"field_type":"long","field_name":"__c5","field_alias":"iterationIndex","field_index":5},{"field_type":"string","field_name":"__c6","field_alias":"__ext","field_index":6},{"field_type":"long","field_name":"__c7","field_alias":"cloudId","field_index":7},{"field_type":"long","field_name":"__c8","field_alias":"gseIndex","field_index":8},{"field_type":"string","field_name":"__c9","field_alias":"path","field_index":9},{"field_type":"long","field_name":"__c10","field_alias":"time","field_index":10},{"field_type":"string","field_name":"__c11","field_alias":"log","field_index":11},{"field_type":"string","field_name":"__c12","field_alias":"message","field_index":12},{"field_type":"string","field_name":"__c13","field_alias":"serverip","field_index":13},{"field_type":"string","field_name":"__c14","field_alias":"trace_id","field_index":14}],"bksql_call_elapsed_time":0,"device":"doris","result_table_ids":["100915_bklog_pub_svrlog_pangusvr_other_other_analysis"]},"errors":null,"trace_id":"0816890bc718ec5786d469e9a79110d2","span_id":"6d04c0ddf758c603"}`,

		// doris time range specific query
		"SELECT *, `dtEventTimeStamp` AS `_value_`, `dtEventTimeStamp` AS `_timestamp_` FROM `2_bklog_bkunify_query_doris`.doris WHERE `dtEventTimeStamp` >= 1723594500000 AND `dtEventTimeStamp` <= 1723594800000 AND `dtEventTime` >= '2024-08-14 08:08:00' AND `dtEventTime` <= '2024-08-14 08:08:30' AND `thedate` = '20240814' LIMIT 5": `{"result":true,"message":"成功","code":"00","data":{"cluster":"codev_doris2","totalRecords":1,"external_api_call_time_mills":{"bkbase_meta_api":10},"resource_use_summary":{"cpu_time_mills":0,"memory_bytes":0,"processed_bytes":0,"processed_rows":0},"source":"","list":[{"dtEventTime":1723594680000,"__shard_key__":29077703957,"dtEventTimeStamp":1723594685000,"thedate":2.0240814e+07,"localtime":"2024-08-14 08:08:05","iterationIndex":23,"__ext":"{\"container_id\":\"late789\",\"container_name\":\"batch-job\",\"io_kubernetes_pod\":\"batch-job-pod-333\"}","cloudId":0,"gseIndex":2450135,"path":"/var/log/batch.log","time":"1723594685","log":"2024-08-14T08:08:05.500Z INFO batch processing completed","message":"batch job completed successfully","serverip":"10.0.0.5","trace_id":"batch001"}],"stage_elapsed_time_mills":{"check_query_syntax":1,"query_db":1800,"get_query_driver":0,"match_query_forbidden_config":0,"convert_query_statement":9,"connect_db":45,"match_query_routing_rule":0,"check_permission":9,"check_query_semantic":0,"pick_valid_storage":1},"select_fields_order":["dtEventTime","__shard_key__","dtEventTimeStamp","thedate","localtime","iterationIndex","__ext","cloudId","gseIndex","path","time","log","message","serverip","trace_id"],"total_record_size":185000,"result_schema":[{"field_type":"long","field_name":"__c0","field_alias":"dtEventTime","field_index":0},{"field_type":"long","field_name":"__c1","field_alias":"__shard_key__","field_index":1},{"field_type":"long","field_name":"__c2","field_alias":"dtEventTimeStamp","field_index":2},{"field_type":"int","field_name":"__c3","field_alias":"thedate","field_index":3},{"field_type":"string","field_name":"__c4","field_alias":"localtime","field_index":4},{"field_type":"long","field_name":"__c5","field_alias":"iterationIndex","field_index":5},{"field_type":"string","field_name":"__c6","field_alias":"__ext","field_index":6},{"field_type":"long","field_name":"__c7","field_alias":"cloudId","field_index":7},{"field_type":"long","field_name":"__c8","field_alias":"gseIndex","field_index":8},{"field_type":"string","field_name":"__c9","field_alias":"path","field_index":9},{"field_type":"long","field_name":"__c10","field_alias":"time","field_index":10},{"field_type":"string","field_name":"__c11","field_alias":"log","field_index":11},{"field_type":"string","field_name":"__c12","field_alias":"message","field_index":12},{"field_type":"string","field_name":"__c13","field_alias":"serverip","field_index":13},{"field_type":"string","field_name":"__c14","field_alias":"trace_id","field_index":14}],"bksql_call_elapsed_time":0,"device":"doris","result_table_ids":["100915_bklog_pub_svrlog_pangusvr_other_other_analysis"]},"errors":null,"trace_id":"0816890bc718ec5786d469e9a79110d2","span_id":"6d04c0ddf758c603"}`,

		// doris time range specific query (actual query generated by test)
		"SELECT *, `dtEventTimeStamp` AS `_value_`, `dtEventTimeStamp` AS `_timestamp_` FROM `2_bklog_bkunify_query_doris`.doris WHERE `dtEventTimeStamp` >= 1723594500000 AND `dtEventTimeStamp` <= 1723594800000 AND `dtEventTime` >= '2024-08-14 08:15:00' AND `dtEventTime` <= '2024-08-14 08:20:01' AND `thedate` = '20240814' LIMIT 5": `{"result":true,"message":"成功","code":"00","data":{"cluster":"codev_doris2","totalRecords":1,"external_api_call_time_mills":{"bkbase_meta_api":10},"resource_use_summary":{"cpu_time_mills":0,"memory_bytes":0,"processed_bytes":0,"processed_rows":0},"source":"","list":[{"dtEventTime":1723594680000,"__shard_key__":29077703957,"dtEventTimeStamp":1723594685000,"thedate":2.0240814e+07,"localtime":"2024-08-14 08:08:05","iterationIndex":23,"__ext":"{\"container_id\":\"late789\",\"container_name\":\"batch-job\",\"io_kubernetes_pod\":\"batch-job-pod-333\"}","cloudId":0,"gseIndex":2450135,"path":"/var/log/batch.log","time":"1723594685","log":"2024-08-14T08:08:05.500Z INFO batch processing completed","message":"batch job completed successfully","serverip":"10.0.0.5","trace_id":"batch001"}],"stage_elapsed_time_mills":{"check_query_syntax":1,"query_db":1800,"get_query_driver":0,"match_query_forbidden_config":0,"convert_query_statement":9,"connect_db":45,"match_query_routing_rule":0,"check_permission":9,"check_query_semantic":0,"pick_valid_storage":1},"select_fields_order":["dtEventTime","__shard_key__","dtEventTimeStamp","thedate","localtime","iterationIndex","__ext","cloudId","gseIndex","path","time","log","message","serverip","trace_id"],"total_record_size":185000,"result_schema":[{"field_type":"long","field_name":"__c0","field_alias":"dtEventTime","field_index":0},{"field_type":"long","field_name":"__c1","field_alias":"__shard_key__","field_index":1},{"field_type":"long","field_name":"__c2","field_alias":"dtEventTimeStamp","field_index":2},{"field_type":"int","field_name":"__c3","field_alias":"thedate","field_index":3},{"field_type":"string","field_name":"__c4","field_alias":"localtime","field_index":4},{"field_type":"long","field_name":"__c5","field_alias":"iterationIndex","field_index":5},{"field_type":"string","field_name":"__c6","field_alias":"__ext","field_index":6},{"field_type":"long","field_name":"__c7","field_alias":"cloudId","field_index":7},{"field_type":"long","field_name":"__c8","field_alias":"gseIndex","field_index":8},{"field_type":"string","field_name":"__c9","field_alias":"path","field_index":9},{"field_type":"long","field_name":"__c10","field_alias":"time","field_index":10},{"field_type":"string","field_name":"__c11","field_alias":"log","field_index":11},{"field_type":"string","field_name":"__c12","field_alias":"message","field_index":12},{"field_type":"string","field_name":"__c13","field_alias":"serverip","field_index":13},{"field_type":"string","field_name":"__c14","field_alias":"trace_id","field_index":14}],"bksql_call_elapsed_time":0,"device":"doris","result_table_ids":["100915_bklog_pub_svrlog_pangusvr_other_other_analysis"]},"errors":null,"trace_id":"0816890bc718ec5786d469e9a79110d2","span_id":"6d04c0ddf758c603"}`,
	})

	tests := map[string]struct {
		queryDirect *structured.QueryDirect
		total       int64
		expected    string
		options     string
	}{
		"basic query direct test": {
			queryDirect: &structured.QueryDirect{
				SpaceUid: spaceUid,
				References: metadata.QueryReference{
					"a": []*metadata.QueryMetric{
						{
							ReferenceName: "a",
							MetricName:    "dtEventTimeStamp",
							QueryList: []*metadata.Query{
								{
									DataSource:  "bkdata",
									TableID:     "result_table.bk_base_es",
									StorageType: "elasticsearch",
									StorageID:   "0",
									SourceType:  structured.BkData,
									ClusterName: "",
									DB:          "es_index",
									Measurement: "",
									Field:       "dtEventTimeStamp",
								},
							},
						},
					},
				},
				Start: start,
				End:   end,
				Limit: 10,
				From:  0,
			},
			total:    10000,
			expected: `[{"__data_label":"","__doc_id":"c726c895a380ba1a9df04ba4a977b29b","__ext.container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f","__index":"v2_2_bklog_bk_unify_query_20240814_0","__result_table":"result_table.bk_base_es","_time":"1723594161000","dtEventTimeStamp":"1723594161000"},{"__data_label":"","__doc_id":"f6950fef394e813999d7316cdbf0de4d","__ext.container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f","__index":"v2_2_bklog_bk_unify_query_20240814_0","__result_table":"result_table.bk_base_es","_time":"1723594161000","dtEventTimeStamp":"1723594161000"}]`,
			options:  `{"result_table.bk_base_es|0":{"from":0}}`,
		},
		"query with highlight enabled": {
			queryDirect: &structured.QueryDirect{
				SpaceUid: spaceUid,
				References: metadata.QueryReference{
					"a": []*metadata.QueryMetric{
						{
							ReferenceName: "a",
							MetricName:    "dtEventTimeStamp",
							QueryList: []*metadata.Query{
								{
									DataSource:  "bkdata",
									TableID:     "result_table.bk_base_es",
									StorageType: "elasticsearch",
									StorageID:   "0",
									SourceType:  structured.BkData,
									ClusterName: "",
									DB:          "es_index",
									Measurement: "",
									Field:       "dtEventTimeStamp",
									AllConditions: metadata.AllConditions{
										{
											{
												DimensionName: "message",
												Value:         []string{"test"},
												Operator:      metadata.ConditionContains,
											},
										},
									},
								},
							},
						},
					},
				},
				Start: start,
				End:   end,
				Limit: 2,
				HighLight: &metadata.HighLight{
					Enable:            true,
					MaxAnalyzedOffset: 1000,
				},
			},
			total:    10000,
			expected: `[{"__data_label":"","__doc_id":"c726c895a380ba1a9df04ba4a977b29b","__ext.container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f","__highlight":{"message":["this is a <mark>test</mark> message"]},"__index":"v2_2_bklog_bk_unify_query_20240814_0","__result_table":"result_table.bk_base_es","_time":"1723594161000","dtEventTimeStamp":"1723594161000","message":"this is a test message"},{"__data_label":"","__doc_id":"f6950fef394e813999d7316cdbf0de4d","__ext.container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f","__highlight":{"message":["another <mark>test</mark> log entry"]},"__index":"v2_2_bklog_bk_unify_query_20240814_0","__result_table":"result_table.bk_base_es","_time":"1723594161000","dtEventTimeStamp":"1723594161000","message":"another test log entry"}]`,
			options:  `{"result_table.bk_base_es|0":{"from":0}}`,
		},
		"nested query with query string and highlight enabled": {
			queryDirect: &structured.QueryDirect{
				SpaceUid: spaceUid,
				References: metadata.QueryReference{
					"a": []*metadata.QueryMetric{
						{
							ReferenceName: "a",
							MetricName:    "dtEventTimeStamp",
							QueryList: []*metadata.Query{
								{
									DataSource:  "bkdata",
									TableID:     "result_table.bk_base_es",
									StorageType: "elasticsearch",
									StorageID:   "0",
									SourceType:  structured.BkData,
									ClusterName: "",
									DB:          "es_index",
									Measurement: "",
									Field:       "dtEventTimeStamp",
									QueryString: "container_name:unify-query",
									AllConditions: metadata.AllConditions{
										{
											{
												DimensionName: "message",
												Value:         []string{"error"},
												Operator:      metadata.ConditionContains,
											},
											{
												DimensionName: "__ext.io_kubernetes_pod",
												Value:         []string{"bk-datalink-unify-query-6df8bcc4c9-rk4sc"},
												Operator:      metadata.ConditionContains,
											},
											{
												DimensionName: "__ext.container_name",
												Value:         []string{"unify-query"},
												Operator:      metadata.ConditionContains,
											},
										},
									},
								},
							},
						},
					},
				},
				Start: start,
				End:   end,
				Limit: 2,
				HighLight: &metadata.HighLight{
					Enable:            true,
					MaxAnalyzedOffset: 1000,
				},
			},
			total:    10000,
			expected: `[{"__data_label":"","__doc_id":"c726c895a380ba1a9df04ba4a977b29b","__ext.container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f","__ext.container_name":"unify-query","__ext.io_kubernetes_pod":"bk-datalink-unify-query-6df8bcc4c9-rk4sc","__highlight":{"__ext.container_name":["<mark>unify-query</mark>"],"__ext.io_kubernetes_pod":["<mark>bk-datalink-unify-query-6df8bcc4c9-rk4sc</mark>"],"message":["database connection <mark>error</mark> occurred"]},"__index":"v2_2_bklog_bk_unify_query_20240814_0","__result_table":"result_table.bk_base_es","_time":"1723594161000","dtEventTimeStamp":"1723594161000","message":"database connection error occurred"},{"__data_label":"","__doc_id":"f6950fef394e813999d7316cdbf0de4d","__ext.container_id":"77bd897e66402eb66ee97a1f832fb55b2114d83dc369f01e36ce4cec8483786f","__ext.container_name":"unify-query","__ext.io_kubernetes_pod":"bk-datalink-unify-query-6df8bcc4c9-rk4sc","__highlight":{"__ext.container_name":["<mark>unify-query</mark>"],"__ext.io_kubernetes_pod":["<mark>bk-datalink-unify-query-6df8bcc4c9-rk4sc</mark>"],"message":["fatal <mark>error</mark> in processing request"]},"__index":"v2_2_bklog_bk_unify_query_20240814_0","__result_table":"result_table.bk_base_es","_time":"1723594161000","dtEventTimeStamp":"1723594161000","message":"fatal error in processing request"}]`,
			options:  `{"result_table.bk_base_es|0":{"from":0}}`,
		},
		"doris basic query": {
			queryDirect: &structured.QueryDirect{
				SpaceUid: spaceUid,
				References: metadata.QueryReference{
					"a": []*metadata.QueryMetric{
						{
							ReferenceName: "a",
							MetricName:    "dtEventTimeStamp",
							QueryList: []*metadata.Query{
								{
									DataSource:  structured.BkLog,
									TableID:     "result_table.doris",
									StorageType: "bk_sql",
									StorageID:   "4",
									SourceType:  structured.BkLog,
									ClusterName: "",
									DB:          "2_bklog_bkunify_query_doris",
									Measurement: "doris",
									Field:       "dtEventTimeStamp",
								},
							},
						},
					},
				},
				Start: start,
				End:   end,
				Limit: 10,
			},
			total:    3,
			expected: `[{"__data_label":"","__ext.container_id":"abc123def456","__ext.container_name":"app-server","__ext.io_kubernetes_pod":"app-server-pod-123","__index":"2_bklog_bkunify_query_doris","__result_table":"result_table.doris","__shard_key__":2.907770395e+10,"cloudId":0,"dtEventTime":1.7235941e+12,"dtEventTimeStamp":1.723594105e+12,"gseIndex":2.450128e+06,"iterationIndex":15,"localtime":"2024-08-14 08:06:40","log":"2024-08-14T08:06:40.500Z INFO application started","message":"application started successfully","path":"/var/log/application.log","serverip":"10.0.0.1","thedate":2.0240814e+07,"time":"1723594105","trace_id":"info001"},{"__data_label":"","__ext.container_id":"def789ghi012","__ext.container_name":"web-server","__ext.io_kubernetes_pod":"web-server-pod-456","__index":"2_bklog_bkunify_query_doris","__result_table":"result_table.doris","__shard_key__":2.9077703951e+10,"cloudId":0,"dtEventTime":1.72359415e+12,"dtEventTimeStamp":1.723594158e+12,"gseIndex":2.450129e+06,"iterationIndex":17,"localtime":"2024-08-14 08:06:41","log":"2024-08-14T08:06:41.800Z INFO nginx server running","message":"nginx server is running","path":"/var/log/nginx.log","serverip":"10.0.0.2","thedate":2.0240814e+07,"time":"1723594158","trace_id":"info002"},{"__data_label":"","__ext.container_id":"ghi345jkl678","__ext.container_name":"database","__ext.io_kubernetes_pod":"database-pod-789","__index":"2_bklog_bkunify_query_doris","__result_table":"result_table.doris","__shard_key__":2.9077703952e+10,"cloudId":0,"dtEventTime":1.72359425e+12,"dtEventTimeStamp":1.723594252e+12,"gseIndex":2.45013e+06,"iterationIndex":18,"localtime":"2024-08-14 08:06:43","log":"2024-08-14T08:06:43.200Z INFO database connected","message":"database connection established","path":"/var/log/mysql.log","serverip":"10.0.0.3","thedate":2.0240814e+07,"time":"1723594252","trace_id":"info003"}]`,
			options:  `{"result_table.doris|4":{"result_schema":[{"field_alias":"dtEventTime","field_index":0,"field_name":"__c0","field_type":"long"},{"field_alias":"__shard_key__","field_index":1,"field_name":"__c1","field_type":"long"},{"field_alias":"dtEventTimeStamp","field_index":2,"field_name":"__c2","field_type":"long"},{"field_alias":"thedate","field_index":3,"field_name":"__c3","field_type":"int"},{"field_alias":"localtime","field_index":4,"field_name":"__c4","field_type":"string"},{"field_alias":"iterationIndex","field_index":5,"field_name":"__c5","field_type":"long"},{"field_alias":"__ext","field_index":6,"field_name":"__c6","field_type":"string"},{"field_alias":"cloudId","field_index":7,"field_name":"__c7","field_type":"long"},{"field_alias":"gseIndex","field_index":8,"field_name":"__c8","field_type":"long"},{"field_alias":"path","field_index":9,"field_name":"__c9","field_type":"string"},{"field_alias":"time","field_index":10,"field_name":"__c10","field_type":"long"},{"field_alias":"log","field_index":11,"field_name":"__c11","field_type":"string"},{"field_alias":"message","field_index":12,"field_name":"__c12","field_type":"string"},{"field_alias":"serverip","field_index":13,"field_name":"__c13","field_type":"string"},{"field_alias":"trace_id","field_index":14,"field_name":"__c14","field_type":"string"}]}}`,
		},
		"doris complex conditions query": {
			queryDirect: &structured.QueryDirect{
				SpaceUid: spaceUid,
				References: metadata.QueryReference{
					"a": []*metadata.QueryMetric{
						{
							ReferenceName: "a",
							MetricName:    "dtEventTimeStamp",
							QueryList: []*metadata.Query{
								{
									DataSource:  structured.BkLog,
									TableID:     "result_table.doris",
									StorageType: "bk_sql",
									StorageID:   "4",
									SourceType:  structured.BkLog,
									ClusterName: "",
									DB:          "2_bklog_bkunify_query_doris",
									Measurement: "doris",
									Field:       "dtEventTimeStamp",
									AllConditions: metadata.AllConditions{
										{
											{
												DimensionName: "message",
												Value:         []string{"warning", "critical"},
												Operator:      metadata.ConditionContains,
											},
											{
												DimensionName: "serverip",
												Value:         []string{"10.0.0.1"},
												Operator:      metadata.ConditionEqual,
											},
										},
									},
								},
							},
						},
					},
				},
				Start: start,
				End:   end,
				Limit: 50,
			},
			total:    2,
			expected: `[{"__data_label":"","__ext.container_id":"warning123","__ext.container_name":"monitor","__ext.io_kubernetes_pod":"monitor-pod-111","__index":"2_bklog_bkunify_query_doris","__result_table":"result_table.doris","__shard_key__":2.9077703955e+10,"cloudId":0,"dtEventTime":1.7235943e+12,"dtEventTimeStamp":1.723594305e+12,"gseIndex":2.450133e+06,"iterationIndex":21,"localtime":"2024-08-14 08:06:44","log":"2024-08-14T08:06:44.500Z WARNING high memory usage detected","message":"high memory usage detected on server","path":"/var/log/monitor.log","serverip":"10.0.0.1","thedate":2.0240814e+07,"time":"1723594305","trace_id":"warn001"},{"__data_label":"","__ext.container_id":"critical456","__ext.container_name":"alert-system","__ext.io_kubernetes_pod":"alert-pod-222","__index":"2_bklog_bkunify_query_doris","__result_table":"result_table.doris","__shard_key__":2.9077703956e+10,"cloudId":0,"dtEventTime":1.72359435e+12,"dtEventTimeStamp":1.723594358e+12,"gseIndex":2.450134e+06,"iterationIndex":22,"localtime":"2024-08-14 08:06:46","log":"2024-08-14T08:06:46.800Z CRITICAL service unavailable","message":"critical service failure detected","path":"/var/log/alert.log","serverip":"10.0.0.1","thedate":2.0240814e+07,"time":"1723594358","trace_id":"crit001"}]`,
			options:  `{"result_table.doris|4":{"result_schema":[{"field_alias":"dtEventTime","field_index":0,"field_name":"__c0","field_type":"long"},{"field_alias":"__shard_key__","field_index":1,"field_name":"__c1","field_type":"long"},{"field_alias":"dtEventTimeStamp","field_index":2,"field_name":"__c2","field_type":"long"},{"field_alias":"thedate","field_index":3,"field_name":"__c3","field_type":"int"},{"field_alias":"localtime","field_index":4,"field_name":"__c4","field_type":"string"},{"field_alias":"iterationIndex","field_index":5,"field_name":"__c5","field_type":"long"},{"field_alias":"__ext","field_index":6,"field_name":"__c6","field_type":"string"},{"field_alias":"cloudId","field_index":7,"field_name":"__c7","field_type":"long"},{"field_alias":"gseIndex","field_index":8,"field_name":"__c8","field_type":"long"},{"field_alias":"path","field_index":9,"field_name":"__c9","field_type":"string"},{"field_alias":"time","field_index":10,"field_name":"__c10","field_type":"long"},{"field_alias":"log","field_index":11,"field_name":"__c11","field_type":"string"},{"field_alias":"message","field_index":12,"field_name":"__c12","field_type":"string"},{"field_alias":"serverip","field_index":13,"field_name":"__c13","field_type":"string"},{"field_alias":"trace_id","field_index":14,"field_name":"__c14","field_type":"string"}]}}`,
		},
		"doris time range specific query": {
			queryDirect: &structured.QueryDirect{
				SpaceUid: spaceUid,
				References: metadata.QueryReference{
					"a": []*metadata.QueryMetric{
						{
							ReferenceName: "a",
							MetricName:    "dtEventTimeStamp",
							QueryList: []*metadata.Query{
								{
									DataSource:  structured.BkLog,
									TableID:     "result_table.doris",
									StorageType: "bk_sql",
									StorageID:   "4",
									SourceType:  structured.BkLog,
									ClusterName: "",
									DB:          "2_bklog_bkunify_query_doris",
									Measurement: "doris",
									Field:       "dtEventTimeStamp",
								},
							},
						},
					},
				},
				Start: "1723594500",
				End:   "1723594800",
				Limit: 5,
			},
			total:    1,
			expected: `[{"__data_label":"","__ext.container_id":"late789","__ext.container_name":"batch-job","__ext.io_kubernetes_pod":"batch-job-pod-333","__index":"2_bklog_bkunify_query_doris","__result_table":"result_table.doris","__shard_key__":2.9077703957e+10,"cloudId":0,"dtEventTime":1.72359468e+12,"dtEventTimeStamp":1.723594685e+12,"gseIndex":2.450135e+06,"iterationIndex":23,"localtime":"2024-08-14 08:08:05","log":"2024-08-14T08:08:05.500Z INFO batch processing completed","message":"batch job completed successfully","path":"/var/log/batch.log","serverip":"10.0.0.5","thedate":2.0240814e+07,"time":"1723594685","trace_id":"batch001"}]`,
			options:  `{"result_table.doris|4":{"result_schema":[{"field_alias":"dtEventTime","field_index":0,"field_name":"__c0","field_type":"long"},{"field_alias":"__shard_key__","field_index":1,"field_name":"__c1","field_type":"long"},{"field_alias":"dtEventTimeStamp","field_index":2,"field_name":"__c2","field_type":"long"},{"field_alias":"thedate","field_index":3,"field_name":"__c3","field_type":"int"},{"field_alias":"localtime","field_index":4,"field_name":"__c4","field_type":"string"},{"field_alias":"iterationIndex","field_index":5,"field_name":"__c5","field_type":"long"},{"field_alias":"__ext","field_index":6,"field_name":"__c6","field_type":"string"},{"field_alias":"cloudId","field_index":7,"field_name":"__c7","field_type":"long"},{"field_alias":"gseIndex","field_index":8,"field_name":"__c8","field_type":"long"},{"field_alias":"path","field_index":9,"field_name":"__c9","field_type":"string"},{"field_alias":"time","field_index":10,"field_name":"__c10","field_type":"long"},{"field_alias":"log","field_index":11,"field_name":"__c11","field_type":"string"},{"field_alias":"message","field_index":12,"field_name":"__c12","field_type":"string"},{"field_alias":"serverip","field_index":13,"field_name":"__c13","field_type":"string"},{"field_alias":"trace_id","field_index":14,"field_name":"__c14","field_type":"string"}]}}`,
		},
		"doris query with highlight enabled": {
			queryDirect: &structured.QueryDirect{
				SpaceUid: spaceUid,
				References: metadata.QueryReference{
					"a": []*metadata.QueryMetric{
						{
							ReferenceName: "a",
							MetricName:    "dtEventTimeStamp",
							QueryList: []*metadata.Query{
								{
									DataSource:  structured.BkLog,
									TableID:     "result_table.doris",
									StorageType: "bk_sql",
									StorageID:   "4",
									SourceType:  structured.BkLog,
									ClusterName: "",
									DB:          "2_bklog_bkunify_query_doris",
									Measurement: "doris",
									Field:       "dtEventTimeStamp",
									AllConditions: metadata.AllConditions{
										{
											{
												DimensionName: "message",
												Value:         []string{"error"},
												Operator:      metadata.ConditionContains,
											},
											{
												DimensionName: "log",
												Value:         []string{"error"},
												Operator:      metadata.ConditionContains,
											},
										},
									},
								},
							},
						},
					},
				},
				Start: start,
				End:   end,
				Limit: 100,
				HighLight: &metadata.HighLight{
					Enable:            true,
					MaxAnalyzedOffset: 1000,
				},
			},
			total:    2,
			expected: `[{"__data_label":"","__ext.container_id":"375597ee636fd5d53cb7b0958823d9ba6534bd24cd698e485c41ca2f01b78ed2","__ext.container_name":"unify-query","__ext.io_kubernetes_pod":"bk-datalink-unify-query-6df8bcc4c9-rk4sc","__highlight":{"log":["2024-08-14T08:06:41.000Z <mark>error</mark> database connection failed"],"message":["database connection <mark>error</mark> occurred"]},"__index":"2_bklog_bkunify_query_doris","__result_table":"result_table.doris","__shard_key__":2.9077703953e+10,"cloudId":0,"dtEventTime":1.72359416e+12,"dtEventTimeStamp":1.723594161e+12,"gseIndex":2.450131e+06,"iterationIndex":19,"localtime":"2024-08-14 08:06:41","log":"2024-08-14T08:06:41.000Z error database connection failed","message":"database connection error occurred","path":"/var/log/app.log","serverip":"127.0.0.1","thedate":2.0240814e+07,"time":"1723594161","trace_id":"abc123"},{"__data_label":"","__ext.container_id":"375597ee636fd5d53cb7b0958823d9ba6534bd24cd698e485c41ca2f01b78ed2","__ext.container_name":"unify-query","__ext.io_kubernetes_pod":"bk-datalink-unify-query-6df8bcc4c9-rk4sc","__highlight":{"log":["2024-08-14T08:06:42.000Z <mark>error</mark> processing request timeout"],"message":["fatal <mark>error</mark> in processing request"]},"__index":"2_bklog_bkunify_query_doris","__result_table":"result_table.doris","__shard_key__":2.9077703954e+10,"cloudId":0,"dtEventTime":1.7235942e+12,"dtEventTimeStamp":1.723594201e+12,"gseIndex":2.450132e+06,"iterationIndex":20,"localtime":"2024-08-14 08:06:42","log":"2024-08-14T08:06:42.000Z error processing request timeout","message":"fatal error in processing request","path":"/var/log/app.log","serverip":"127.0.0.1","thedate":2.0240814e+07,"time":"1723594202","trace_id":"def456"}]`,
			options:  `{"result_table.doris|4":{"result_schema":[{"field_alias":"dtEventTime","field_index":0,"field_name":"__c0","field_type":"long"},{"field_alias":"__shard_key__","field_index":1,"field_name":"__c1","field_type":"long"},{"field_alias":"dtEventTimeStamp","field_index":2,"field_name":"__c2","field_type":"long"},{"field_alias":"thedate","field_index":3,"field_name":"__c3","field_type":"int"},{"field_alias":"localtime","field_index":4,"field_name":"__c4","field_type":"string"},{"field_alias":"iterationIndex","field_index":5,"field_name":"__c5","field_type":"long"},{"field_alias":"__ext","field_index":6,"field_name":"__c6","field_type":"string"},{"field_alias":"cloudId","field_index":7,"field_name":"__c7","field_type":"long"},{"field_alias":"gseIndex","field_index":8,"field_name":"__c8","field_type":"long"},{"field_alias":"path","field_index":9,"field_name":"__c9","field_type":"string"},{"field_alias":"time","field_index":10,"field_name":"__c10","field_type":"long"},{"field_alias":"log","field_index":11,"field_name":"__c11","field_type":"string"},{"field_alias":"message","field_index":12,"field_name":"__c12","field_type":"string"},{"field_alias":"serverip","field_index":13,"field_name":"__c13","field_type":"string"},{"field_alias":"trace_id","field_index":14,"field_name":"__c14","field_type":"string"}]}}`,
		},
	}

	for name, tt := range tests {
		t.Run(name, func(t *testing.T) {
			total, list, options, err := queryRawWithInstanceDirect(ctx, tt.queryDirect)
			assert.Nil(t, err)
			if err != nil {
				return
			}
			assert.Equal(t, tt.total, total)
			actual := json.MarshalListMap(list)
			assert.Equal(t, tt.expected, actual)
			if len(options) > 0 || tt.options != "" {
				optActual, _ := json.Marshal(options)
				assert.JSONEq(t, tt.options, string(optActual))
			}
		})
	}
}

func TestQueryRawWithInstanceDirectStr(t *testing.T) {
	ctx := metadata.InitHashID(context.Background())

	mock.Init()
	influxdb.MockSpaceRouter(ctx)
	promql.MockEngine()

	mock.Es.Set(map[string]any{
		// basic query direct test
		`{"from":0,"query":{"bool":{"filter":[{"match_phrase":{"trace_id":{"query":"9c53d1e200bbce87c8dd1c0e87df50dd"}}},{"range":{"dtEventTimeStamp":{"format":"epoch_second","from":1723594000,"include_lower":true,"include_upper":true,"to":1723595000}}}]}},"size":10}`: `{"took":23,"timed_out":false,"_shards":{"total":3,"successful":3,"skipped":0,"failed":0},"hits":{"total":{"value":20,"relation":"eq"},"max_score":null,"hits":[{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"1723726616237979000","_score":null,"_source":{"span_name":"/query/ts","trace_state":"","elapsed_time":622,"kind":2,"span_id":"54335015c344e4dc","start_time":1763368372054960,"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","links":[],"events":[],"time":"1763368372000","parent_span_id":"812258428d3bfe6a","end_time":1763368372055582,"status":{"code":0,"message":""},"resource":{"k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2"},"attributes":{"http.user_agent":"python-requests/2.32.5","net.peer.port":52368,"net.transport":"ip_tcp","net.peer.ip":"172.17.1.108","http.server_name":"unify-query","http.route":"/query/ts","http.request_content_length":706,"net.host.port":10205,"http.method":"POST","http.scheme":"http","http.flavor":"1.1","http.status_code":200,"net.host.name":"bk-monitor-unify-query-http","http.target":"/query/ts","http.host":"bk-monitor-unify-query-http:10205","apdex_type":"satisfied"}},"sort":[1763368372054960]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"14558837160600906303","_score":null,"_source":{"status":{"code":0,"message":""},"span_name":"http-api-metadata","events":[],"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","start_time":1763368372054978,"time":"1763368372000","span_id":"59c9cf6b3b8058c8","end_time":1763368372055580,"links":[],"parent_span_id":"54335015c344e4dc","elapsed_time":601,"kind":1,"attributes":{"local-ip":"172.17.99.156","local-host-name":"bk-monitor-unify-query-54f787776f-tvfs2","http-api-query-cost":0,"apdex_type":"satisfied"},"trace_state":"","resource":{"k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2"}},"sort":[1763368372054978]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"18305889214007091275","_score":null,"_source":{"kind":1,"events":[],"trace_state":"","attributes":{"query-body":"{\"space_uid\":\"bkcc__34\",\"query_list\":[{\"table_id\":\"system.mem\",\"field_name\":\"pct_used\",\"is_regexp\":false,\"function\":[{\"method\":\"mean\",\"dimensions\":[\"bk_target_ip\",\"bk_target_cloud_id\"]}],\"time_aggregation\":{\"function\":\"avg_over_time\",\"window\":\"60s\"},\"is_dom_sampled\":false,\"reference_name\":\"a\",\"dimensions\":[\"bk_target_ip\",\"bk_target_cloud_id\"],\"conditions\":{},\"keep_columns\":[\"_time\",\"a\",\"bk_target_ip\",\"bk_target_cloud_id\"],\"query_string\":\"\",\"sql\":\"\",\"is_prefix\":false}],\"metric_merge\":\"a\",\"start_time\":\"1763366460\",\"end_time\":\"1763368320\",\"step\":\"60s\",\"timezone\":\"Asia/Shanghai\",\"instant\":false,\"not_time_align\":false}","apdex_type":"satisfied","query-source":"strategy:64274","query-tenant-id":"system","resp-size":"16","request-url":"/query/ts","query-space-uid":"bkcc__34","query-body-size":621,"request-header":"map[Accept:[*/*] Accept-Encoding:[gzip, deflate] Bk-Query-Source:[strategy:64274] Connection:[keep-alive] Content-Length:[706] Content-Type:[application/json] Traceparent:[00-9c53d1e200bbce87c8dd1c0e87df50dd-812258428d3bfe6a-00] User-Agent:[python-requests/2.32.5] X-Bk-Scope-Space-Uid:[bkcc__34] X-Bk-Tenant-Id:[system]]"},"span_id":"52cb419471ac481a","parent_span_id":"54335015c344e4dc","status":{"message":"","code":0},"resource":{"net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query"},"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","end_time":1763368372055569,"start_time":1763368372054995,"elapsed_time":574,"time":"1763368372000","span_name":"handler-query-ts","links":[]},"sort":[1763368372054995]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"9221852038613677340","_score":null,"_source":{"trace_state":"","events":[],"span_name":"query-ts","status":{"code":0,"message":""},"resource":{"bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking"},"links":[],"kind":1,"end_time":1763368372055546,"time":"1763368372000","elapsed_time":426,"span_id":"6eb1932099f20c26","parent_span_id":"52cb419471ac481a","attributes":{"apdex_type":"satisfied","query-params":"&{ctx:0xc00c8e53e0 AlignStart:2025-11-17 16:01:00 +0800 CST Start:2025-11-17 08:01:00 +0000 UTC End:2025-11-17 08:32:00 +0000 UTC Step:1m0s TimeUnit:second Timezone:Asia/Shanghai StorageType:influxdb IsReference:false IsSkipK8s:false}","stmt":"avg by (bk_target_ip, bk_target_cloud_id) (last_over_time(a[1m] offset -59s999ms))","start":"2025-11-17 16:01:00","end":"2025-11-17 16:32:00","storage-type":"prometheus","step":"1m0s","resp-series-num":0,"resp-points-num":0},"start_time":1763368372055120,"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd"},"sort":[1763368372055120]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"12906353456678359094","_score":null,"_source":{"parent_span_id":"6eb1932099f20c26","links":[],"span_id":"f5b8a2535f4afce7","status":{"code":0,"message":""},"trace_state":"","span_name":"query-ts-to-instance","attributes":{"apdex_type":"satisfied","query-ts":"{\"space_uid\":\"bkcc__34\",\"query_list\":[{\"table_id\":\"system.mem\",\"field_name\":\"pct_used\",\"is_regexp\":false,\"function\":[{\"method\":\"mean\",\"dimensions\":[\"bk_target_ip\",\"bk_target_cloud_id\"]}],\"time_aggregation\":{\"function\":\"avg_over_time\",\"window\":\"60s\"},\"is_dom_sampled\":false,\"reference_name\":\"a\",\"dimensions\":[\"bk_target_ip\",\"bk_target_cloud_id\"],\"conditions\":{},\"keep_columns\":[\"_time\",\"a\",\"bk_target_ip\",\"bk_target_cloud_id\"],\"query_string\":\"\",\"sql\":\"\",\"is_prefix\":false}],\"metric_merge\":\"a\",\"start_time\":\"1763366460\",\"end_time\":\"1763368320\",\"step\":\"60s\",\"timezone\":\"Asia/Shanghai\",\"instant\":false,\"not_time_align\":false}","query-max-routing":4,"singleflight-timeout":"1m0s","storage-type":"prometheus","stmt":"avg by (bk_target_ip, bk_target_cloud_id) (last_over_time(a[1m] offset -59s999ms))"},"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","resource":{"k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000"},"start_time":1763368372055121,"events":[],"elapsed_time":146,"end_time":1763368372055267,"time":"1763368372000","kind":1},"sort":[1763368372055121]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"246970103691037800","_score":null,"_source":{"events":[],"kind":1,"parent_span_id":"f5b8a2535f4afce7","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","span_id":"0ff8932bee46c731","status":{"code":0,"message":""},"time":"1763368372000","span_name":"query-ts-to-query-metric","elapsed_time":63,"start_time":1763368372055168,"attributes":{"query_metric_length":1,"apdex_type":"satisfied","tsdb-num":1,"query_map_length":0},"resource":{"service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:"},"trace_state":"","links":[],"end_time":1763368372055232},"sort":[1763368372055168]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"2005302166009097111","_score":null,"_source":{"events":[],"span_id":"439891671e73c042","attributes":{"tsdb-json":"{\"table_id\":\"system.mem\",\"field\":[\"buffer\",\"cached\",\"free\",\"pct_usable\",\"pct_used\",\"psc_pct_used\",\"psc_used\",\"shared\",\"total\",\"usable\",\"used\"],\"measurement_type\":\"bk_traditional_measurement\",\"filters\":[{\"bk_biz_id\":\"34\"}],\"storage_id\":\"2\",\"cluster_name\":\"default\",\"db\":\"system\",\"measurement\":\"mem\",\"metric_name\":\"pct_used\",\"expand_metric_names\":[\"pct_used\"],\"time_field\":{},\"need_add_time\":false,\"storage_type\":\"influxdb\"}","query-json":"{\"storage_type\":\"influxdb\",\"cluster_name\":\"default\",\"data_source\":\"bkmonitor\",\"table_id\":\"system.mem\",\"db\":\"system\",\"measurement\":\"mem\",\"measurement_type\":\"bk_traditional_measurement\",\"field\":\"pct_used\",\"time_field\":{},\"fields\":[\"pct_used\"],\"measurements\":[\"mem\"],\"metric_names\":[\"bkmonitor:system:mem:pct_used\"],\"condition\":\"bk_biz_id='34'\",\"vm_condition\":\"bk_biz_id=\\\"34\\\", __name__=\\\"pct_used_value\\\"\",\"vm_condition_num\":2,\"offset_info\":{\"OffSet\":0,\"Limit\":0,\"SOffSet\":0,\"SLimit\":0},\"all_conditions\":[[{\"DimensionName\":\"bk_biz_id\",\"Value\":[\"34\"],\"Operator\":\"eq\",\"IsWildcard\":false,\"IsPrefix\":false,\"IsSuffix\":false}]],\"source\":[\"_time\",\"a\",\"bk_target_ip\",\"bk_target_cloud_id\"],\"is_merge_db\":false}","apdex_type":"satisfied"},"elapsed_time":24,"trace_state":"","start_time":1763368372055202,"span_name":"build-metadata-query","kind":1,"parent_span_id":"0ff8932bee46c731","links":[],"resource":{"k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000"},"status":{"code":0,"message":""},"time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","end_time":1763368372055227},"sort":[1763368372055202]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"8398401632188651524","_score":null,"_source":{"start_time":1763368372055283,"end_time":1763368372055504,"resource":{"bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking"},"span_name":"prometheus-query-range","links":[],"elapsed_time":221,"kind":1,"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":"","span_id":"a7091819ae7c067e","parent_span_id":"6eb1932099f20c26","time":"1763368372000","status":{"message":"","code":0},"attributes":{"apdex_type":"satisfied","query-promql":"avg by (bk_target_ip, bk_target_cloud_id) (last_over_time(a[1m] offset -59s999ms))","query-start":"2025-11-17 16:01:00 +0800 CST","query-end":"2025-11-17 08:32:00 +0000 UTC","query-step":"1m0s","query-opts-look-back-delta":"0s","query":"EVAL avg by (bk_target_ip, bk_target_cloud_id) (last_over_time(a[1m] offset -59s999ms))"},"events":[]},"sort":[1763368372055283]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"2792009885908275032","_score":null,"_source":{"elapsed_time":182,"start_time":1763368372055320,"parent_span_id":"a7091819ae7c067e","status":{"message":"","code":0},"resource":{"bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking"},"attributes":{"apdex_type":"satisfied"},"events":[],"links":[],"trace_state":"","span_id":"7a96b8677888af9c","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","kind":1,"time":"1763368373000","end_time":1763368372055502,"span_name":"promqlExec"},"sort":[1763368372055320]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"11472967537133066310","_score":null,"_source":{"status":{"code":0,"message":""},"start_time":1763368372055321,"events":[],"end_time":1763368372055322,"span_id":"e150fc38ff3d9d24","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","elapsed_time":0,"attributes":{"apdex_type":"satisfied"},"links":[],"resource":{"service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:"},"trace_state":"","span_name":"promqlExecQueue","parent_span_id":"7a96b8677888af9c","kind":1,"time":"1763368373000"},"sort":[1763368372055321]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"9442335393992974708","_score":null,"_source":{"span_id":"8317e004454edf91","resource":{"bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking"},"status":{"message":"","code":0},"elapsed_time":173,"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","events":[],"span_name":"promqlEval","start_time":1763368372055324,"trace_state":"","kind":1,"time":"1763368373000","parent_span_id":"7a96b8677888af9c","end_time":1763368372055497,"links":[],"attributes":{"apdex_type":"satisfied"}},"sort":[1763368372055324]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"6810694160745444700","_score":null,"_source":{"span_name":"promqlPrepare","events":[],"parent_span_id":"8317e004454edf91","resource":{"k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156"},"time":"1763368373000","kind":1,"status":{"code":0,"message":""},"span_id":"4a52c34850ef4044","end_time":1763368372055339,"elapsed_time":13,"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":"","start_time":1763368372055326,"attributes":{"apdex_type":"satisfied"},"links":[]},"sort":[1763368372055326]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"9369168363550586372","_score":null,"_source":{"elapsed_time":148,"attributes":{"apdex_type":"satisfied"},"resource":{"service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:"},"status":{"message":"","code":0},"end_time":1763368372055491,"events":[],"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","time":"1763368373000","kind":1,"trace_state":"","start_time":1763368372055343,"span_name":"promqlInnerEval","span_id":"f3081b911a6ddc29","links":[],"parent_span_id":"8317e004454edf91"},"sort":[1763368372055343]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"13398120761968060526","_score":null,"_source":{"time":"1763368373000","start_time":1763368372055345,"attributes":{"apdex_type":"satisfied"},"kind":1,"resource":{"k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2"},"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","span_id":"3cca7e2f498dd441","status":{"code":0,"message":""},"elapsed_time":144,"end_time":1763368372055489,"links":[],"span_name":"promqlInnerEval eval *parser.AggregateExpr","events":[],"parent_span_id":"f3081b911a6ddc29","trace_state":""},"sort":[1763368372055345]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"13508859187836164825","_score":null,"_source":{"status":{"message":"","code":0},"trace_state":"","start_time":1763368372055348,"span_name":"promqlInnerEval eval *parser.Call","links":[],"parent_span_id":"3cca7e2f498dd441","attributes":{"apdex_type":"satisfied"},"time":"1763368373000","kind":1,"resource":{"bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking"},"events":[],"elapsed_time":130,"span_id":"cf8bacf4b10caf56","end_time":1763368372055479,"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd"},"sort":[1763368372055348]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"1998064304147583794","_score":null,"_source":{"events":[],"links":[],"time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","resource":{"bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking"},"parent_span_id":"4a52c34850ef4044","span_name":"prometheus-querier-select-fn","start_time":1763368372055369,"attributes":{"reference_name":"a","apdex_type":"satisfied","max-routing":4},"kind":1,"status":{"code":0,"message":""},"span_id":"d0a6223b5cfaaf02","trace_state":"","end_time":1763368372055470,"elapsed_time":100},"sort":[1763368372055369]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"32579495097157821","_score":null,"_source":{"trace_state":"","links":[],"span_name":"querier-get-query-list","status":{"message":"","code":0},"end_time":1763368372055458,"events":[],"span_id":"b2925c20e839f795","time":"1763368372000","parent_span_id":"4a52c34850ef4044","resource":{"bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking"},"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","elapsed_time":76,"start_time":1763368372055382,"kind":1,"attributes":{"apdex_type":"satisfied"}},"sort":[1763368372055382]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"1059592059049666380","_score":null,"_source":{"span_name":"get-ts-db-instance","status":{"code":2,"message":"查询实例构建异常"},"kind":1,"resource":{"service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:"},"end_time":1763368372055447,"attributes":{"storage-type":"influxdb","apdex_type":"satisfied","storage-id":"2"},"span_id":"8427ad31e2f05930","elapsed_time":52,"trace_state":"","links":[],"start_time":1763368372055395,"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","parent_span_id":"b2925c20e839f795","events":[{"name":"exception","timestamp":1763368372055447,"attributes":{"exception.type":"*errors.fundamental","exception.message":"查询实例构建异常"}}],"time":"1763368372000"},"sort":[1763368372055395]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"9430091773530007104","_score":null,"_source":{"elapsed_time":9,"time":"1763368372000","span_id":"6f764fa96c775c06","span_name":"get-influxdb-host","resource":{"k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query","net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000"},"links":[],"attributes":{"apdex_type":"satisfied"},"events":[],"trace_state":"","kind":1,"end_time":1763368372055408,"parent_span_id":"8427ad31e2f05930","status":{"code":0,"message":""},"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","start_time":1763368372055399},"sort":[1763368372055399]},{"_index":"v2_2_bkapm_trace_tilapia_20251117_0","_type":"_doc","_id":"3772544472043277736","_score":null,"_source":{"status":{"code":0,"message":""},"time":"1763368373000","attributes":{"apdex_type":"satisfied"},"trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","end_time":1763368372055496,"elapsed_time":1,"events":[],"resource":{"net.host.ip":"172.17.99.156","k8s.pod.ip":"172.17.99.156","k8s.bcs.cluster.id":"BCS-K8S-00000","k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","k8s.namespace.name":"blueking","bk.instance.id":":unify-query::172.17.99.156:","service.name":"unify-query"},"span_name":"promqlSort","start_time":1763368372055494,"span_id":"ca8e343a0dfea79d","links":[],"trace_state":"","parent_span_id":"8317e004454edf91","kind":1},"sort":[1763368372055494]}]}}`,
	})

	tests := map[string]struct {
		queryDirectStr string
		total          int64
		expected       string
		options        string
	}{
		"basic query direct test": {
			queryDirectStr: `{
    "space_uid": "bkcc__2",
    "references": {
        "a": [
            {
                "reference_name": "a",
                "metric_name": "dtEventTimeStamp",
                "query_list": [
                    {
                        "data_source": "bkdata",
                        "table_id": "result_table.bk_base_es",
                        "storage_type": "elasticsearch",
                        "storage_id": "0",
                        "source_type": "bkdata",
                        "cluster_name": "",
                        "db": "es_index",
                        "measurement": "__default__",
                        "field": "",
                        "timezone": "Asia/Shanghai",
                        "all_conditions": [
                            [
                                {
                                    "DimensionName": "trace_id",
                                    "Value": [
                                        "9c53d1e200bbce87c8dd1c0e87df50dd"
                                    ],
                                    "Operator": "eq",
                                    "IsWildcard": false,
                                    "IsPrefix": false,
                                    "IsSuffix": false
                                }
                            ]
                        ],
                        "orders": [
                            {
                                "Name": "start_time",
                                "Ast": true
                            }
                        ]
                    }
                ]
            }
        ]
    },
    "start_time": "1723594000",
    "end_time": "1723595000",
    "limit": 10,
    "from": 0
}`,
			total:    20,
			expected: `[{"__data_label":"","__doc_id":"1723726616237979000","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":"1.1","attributes.http.host":"bk-monitor-unify-query-http:10205","attributes.http.method":"POST","attributes.http.request_content_length":706,"attributes.http.route":"/query/ts","attributes.http.scheme":"http","attributes.http.server_name":"unify-query","attributes.http.status_code":200,"attributes.http.target":"/query/ts","attributes.http.user_agent":"python-requests/2.32.5","attributes.net.host.name":"bk-monitor-unify-query-http","attributes.net.host.port":10205,"attributes.net.peer.ip":"172.17.1.108","attributes.net.peer.port":52368,"attributes.net.transport":"ip_tcp","elapsed_time":622,"end_time":1763368372055582,"events":[],"kind":2,"links":[],"parent_span_id":"812258428d3bfe6a","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"54335015c344e4dc","span_name":"/query/ts","start_time":1763368372054960,"status.code":0,"status.message":"","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"14558837160600906303","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":601,"end_time":1763368372055580,"events":[],"kind":1,"links":[],"parent_span_id":"54335015c344e4dc","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"59c9cf6b3b8058c8","span_name":"http-api-metadata","start_time":1763368372054978,"status.code":0,"status.message":"","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"18305889214007091275","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":574,"end_time":1763368372055569,"events":[],"kind":1,"links":[],"parent_span_id":"54335015c344e4dc","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"52cb419471ac481a","span_name":"handler-query-ts","start_time":1763368372054995,"status.code":0,"status.message":"","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"9221852038613677340","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":426,"end_time":1763368372055546,"events":[],"kind":1,"links":[],"parent_span_id":"52cb419471ac481a","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"6eb1932099f20c26","span_name":"query-ts","start_time":1763368372055120,"status.code":0,"status.message":"","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"12906353456678359094","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":146,"end_time":1763368372055267,"events":[],"kind":1,"links":[],"parent_span_id":"6eb1932099f20c26","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"f5b8a2535f4afce7","span_name":"query-ts-to-instance","start_time":1763368372055121,"status.code":0,"status.message":"","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"246970103691037800","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":63,"end_time":1763368372055232,"events":[],"kind":1,"links":[],"parent_span_id":"f5b8a2535f4afce7","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"0ff8932bee46c731","span_name":"query-ts-to-query-metric","start_time":1763368372055168,"status.code":0,"status.message":"","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"2005302166009097111","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":24,"end_time":1763368372055227,"events":[],"kind":1,"links":[],"parent_span_id":"0ff8932bee46c731","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"439891671e73c042","span_name":"build-metadata-query","start_time":1763368372055202,"status.code":0,"status.message":"","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"8398401632188651524","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":221,"end_time":1763368372055504,"events":[],"kind":1,"links":[],"parent_span_id":"6eb1932099f20c26","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"a7091819ae7c067e","span_name":"prometheus-query-range","start_time":1763368372055283,"status.code":0,"status.message":"","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"2792009885908275032","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":182,"end_time":1763368372055502,"events":[],"kind":1,"links":[],"parent_span_id":"a7091819ae7c067e","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"7a96b8677888af9c","span_name":"promqlExec","start_time":1763368372055320,"status.code":0,"status.message":"","time":"1763368373000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"11472967537133066310","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":0,"end_time":1763368372055322,"events":[],"kind":1,"links":[],"parent_span_id":"7a96b8677888af9c","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"e150fc38ff3d9d24","span_name":"promqlExecQueue","start_time":1763368372055321,"status.code":0,"status.message":"","time":"1763368373000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"9442335393992974708","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":173,"end_time":1763368372055497,"events":[],"kind":1,"links":[],"parent_span_id":"7a96b8677888af9c","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"8317e004454edf91","span_name":"promqlEval","start_time":1763368372055324,"status.code":0,"status.message":"","time":"1763368373000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"6810694160745444700","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":13,"end_time":1763368372055339,"events":[],"kind":1,"links":[],"parent_span_id":"8317e004454edf91","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"4a52c34850ef4044","span_name":"promqlPrepare","start_time":1763368372055326,"status.code":0,"status.message":"","time":"1763368373000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"9369168363550586372","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":148,"end_time":1763368372055491,"events":[],"kind":1,"links":[],"parent_span_id":"8317e004454edf91","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"f3081b911a6ddc29","span_name":"promqlInnerEval","start_time":1763368372055343,"status.code":0,"status.message":"","time":"1763368373000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"13398120761968060526","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":144,"end_time":1763368372055489,"events":[],"kind":1,"links":[],"parent_span_id":"f3081b911a6ddc29","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"3cca7e2f498dd441","span_name":"promqlInnerEval eval *parser.AggregateExpr","start_time":1763368372055345,"status.code":0,"status.message":"","time":"1763368373000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"13508859187836164825","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":130,"end_time":1763368372055479,"events":[],"kind":1,"links":[],"parent_span_id":"3cca7e2f498dd441","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"cf8bacf4b10caf56","span_name":"promqlInnerEval eval *parser.Call","start_time":1763368372055348,"status.code":0,"status.message":"","time":"1763368373000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"1998064304147583794","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":100,"end_time":1763368372055470,"events":[],"kind":1,"links":[],"parent_span_id":"4a52c34850ef4044","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"d0a6223b5cfaaf02","span_name":"prometheus-querier-select-fn","start_time":1763368372055369,"status.code":0,"status.message":"","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"32579495097157821","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":76,"end_time":1763368372055458,"events":[],"kind":1,"links":[],"parent_span_id":"4a52c34850ef4044","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"b2925c20e839f795","span_name":"querier-get-query-list","start_time":1763368372055382,"status.code":0,"status.message":"","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"1059592059049666380","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":52,"end_time":1763368372055447,"events":[{"attributes":{"exception.message":"查询实例构建异常","exception.type":"*errors.fundamental"},"name":"exception","timestamp":1763368372055447}],"kind":1,"links":[],"parent_span_id":"b2925c20e839f795","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"8427ad31e2f05930","span_name":"get-ts-db-instance","start_time":1763368372055395,"status.code":2,"status.message":"查询实例构建异常","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"9430091773530007104","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":9,"end_time":1763368372055408,"events":[],"kind":1,"links":[],"parent_span_id":"8427ad31e2f05930","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"6f764fa96c775c06","span_name":"get-influxdb-host","start_time":1763368372055399,"status.code":0,"status.message":"","time":"1763368372000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""},{"__data_label":"","__doc_id":"3772544472043277736","__index":"v2_2_bkapm_trace_tilapia_20251117_0","__result_table":"result_table.bk_base_es","attributes.apdex_type":"satisfied","attributes.http.flavor":<nil>,"attributes.http.host":<nil>,"attributes.http.method":<nil>,"attributes.http.request_content_length":<nil>,"attributes.http.route":<nil>,"attributes.http.scheme":<nil>,"attributes.http.server_name":<nil>,"attributes.http.status_code":<nil>,"attributes.http.target":<nil>,"attributes.http.user_agent":<nil>,"attributes.net.host.name":<nil>,"attributes.net.host.port":<nil>,"attributes.net.peer.ip":<nil>,"attributes.net.peer.port":<nil>,"attributes.net.transport":<nil>,"elapsed_time":1,"end_time":1763368372055496,"events":[],"kind":1,"links":[],"parent_span_id":"8317e004454edf91","resource.bk.instance.id":":unify-query::172.17.99.156:","resource.k8s.bcs.cluster.id":"BCS-K8S-00000","resource.k8s.namespace.name":"blueking","resource.k8s.pod.ip":"172.17.99.156","resource.k8s.pod.name":"bk-monitor-unify-query-54f787776f-tvfs2","resource.net.host.ip":"172.17.99.156","resource.service.name":"unify-query","span_id":"ca8e343a0dfea79d","span_name":"promqlSort","start_time":1763368372055494,"status.code":0,"status.message":"","time":"1763368373000","trace_id":"9c53d1e200bbce87c8dd1c0e87df50dd","trace_state":""}]`,
			options:  `{"result_table.bk_base_es|0":{"from":0,"search_after":[1763368372055494]}}`,
		},
	}

	for name, tt := range tests {
		t.Run(name, func(t *testing.T) {
			var queryDirect structured.QueryDirect
			err := json.Unmarshal([]byte(tt.queryDirectStr), &queryDirect)
			assert.Nil(t, err)
			if err != nil {
				return
			}

			total, list, options, err := queryRawWithInstanceDirect(ctx, &queryDirect)
			assert.Nil(t, err)
			if err != nil {
				return
			}
			assert.Equal(t, tt.total, total)
			actual := json.MarshalListMap(list)
			assert.Equal(t, tt.expected, actual)
			if len(options) > 0 || tt.options != "" {
				optActual, _ := json.Marshal(options)
				optActualStr := string(optActual)
				assert.JSONEq(t, tt.options, optActualStr)
			}
		})
	}
}
