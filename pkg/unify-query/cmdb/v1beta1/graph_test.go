// Tencent is pleased to support the open source community by making
// 蓝鲸智云 - 监控平台 (BlueKing - Monitor) available.
// Copyright (C) 2022 THL A29 Limited, a Tencent company. All rights reserved.
// Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License.
// You may obtain a copy of the License at http://opensource.org/licenses/MIT
// Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
// an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
// specific language governing permissions and limitations under the License.

package v1beta1

import (
	"context"
	"errors"
	"fmt"
	"runtime"
	"strings"
	"sync"
	"testing"
	"time"

	"github.com/dominikbraun/graph"
	"github.com/stretchr/testify/assert"

	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/cmdb"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/influxdb"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/internal/query"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/log"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/metadata"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/mock"
	"github.com/TencentBlueKing/bkmonitor-datalink/pkg/unify-query/tsdb/prometheus"
)

// BenchmarkGraphQuery_New 测试创建 GraphQuery 的性能
func BenchmarkGraphQuery_New(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	for i := 0; i < b.N; i++ {
		_ = graph.New(graph.IntHash, graph.Directed())
	}
}

// BenchmarkGraphQuery_BuildSmallGraph 测试构建小规模图的性能
func BenchmarkGraphQuery_BuildSmallGraph(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	for i := 0; i < b.N; i++ {
		g := graph.New(graph.IntHash, graph.Directed())
		// 构建包含10个节点的小图
		for j := 0; j < 10; j++ {
			_ = g.AddVertex(j)
		}

		// 添加一些边
		for j := 0; j < 9; j++ {
			_ = g.AddEdge(j, j+1)
		}
	}
}

// BenchmarkGraphQuery_BuildMediumGraph 测试构建中等规模图的性能
func BenchmarkGraphQuery_BuildMediumGraph(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	for i := 0; i < b.N; i++ {
		g := graph.New(graph.IntHash, graph.Directed())
		// 构建包含100个节点的中等图
		for j := 0; j < 100; j++ {
			_ = g.AddVertex(j)
		}

		// 添加边，形成链式结构
		for j := 0; j < 99; j++ {
			_ = g.AddEdge(j, j+1)
		}
	}
}

// BenchmarkGraphQuery_BuildLargeGraph 测试构建大规模图的性能
func BenchmarkGraphQuery_BuildLargeGraph(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	b.StopTimer()

	// 预先生成节点和边数据，避免在计时中包含数据生成时间
	nodes := make([]int, 1000)
	for i := 0; i < 1000; i++ {
		nodes[i] = i
	}

	b.StartTimer()

	for i := 0; i < b.N; i++ {
		g := graph.New(graph.IntHash, graph.Directed())
		// 构建包含1000个节点的大图
		for _, node := range nodes {
			_ = g.AddVertex(node)
		}

		// 添加边，形成链式结构
		for j := 0; j < 999; j++ {
			_ = g.AddEdge(nodes[i], nodes[i+1])
		}
	}
}

// BenchmarkGraphQuery_Traversal 测试图遍历的性能
func BenchmarkGraphQuery_Traversal(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	// 先构建一个测试图
	g := graph.New(graph.IntHash, graph.Directed())

	// 构建包含50个节点的图
	nodes := make([]int, 50)
	for i := 0; i < 50; i++ {
		nodes[i] = i
		_ = g.AddVertex(nodes[i])
	}

	// 添加边，形成链式结构
	for i := 0; i < 49; i++ {
		_ = g.AddEdge(nodes[i], nodes[i+1])
	}

	b.ResetTimer()

	for i := 0; i < b.N; i++ {
		// 测试图的遍历性能
		_, _ = g.Order()
		_, _ = g.Size()
	}
}

// BenchmarkGraphQuery_BuildClusterRelation 测试构建集群关系图的性能
func BenchmarkGraphQuery_BuildClusterRelation(b *testing.B) {
	b.ReportAllocs() // 报告内存分配
	b.StopTimer()

	// 预先生成节点和边数据，避免在计时中包含数据生成时间

	nodes := make([]int, 1000)
	for i := 0; i < 1000; i++ {
		nodes[i] = i
	}

	b.StartTimer()

	for i := 0; i < b.N; i++ {
		g := graph.New(graph.IntHash, graph.Directed())

		// 构建包含1000个节点的大图
		for _, node := range nodes {
			_ = g.AddVertex(node)
		}

		// 添加边，形成链式结构
		for j := 0; j < 999; j++ {
			_ = g.AddEdge(nodes[j], nodes[j+1])
		}
	}
}

type data struct {
	source cmdb.Resource
	target cmdb.Resource
	info   cmdb.Matcher
	time   []int64
}

func mockData(podNum, timeNum int) []data {
	source := cmdb.Resource("pod")
	target := cmdb.Resource("container")
	startTime := 1763636985
	var d []data
	for i := 0; i < podNum; i++ {
		for j := 0; j < 2; j++ {
			info := map[string]string{
				"bcs_cluster_id": "BCS-K8S-00000",
				"namespace":      "blueking",
				"pod":            fmt.Sprintf("test-pod-%d", i),
				"container":      fmt.Sprintf("test-container-%d", j),
			}
			times := make([]int64, 0, timeNum)
			for n := 0; n < timeNum; n++ {
				times = append(times, int64(startTime+n*60))
			}
			d = append(d, data{
				source: source,
				target: target,
				info:   info,
				time:   times,
			})
		}
	}
	return d
}

func BenchmarkGraphQuery_CreateGraph(b *testing.B) {
	b.ReportAllocs() // 报告内存分配

	// 预先生成测试数据
	tg := make(map[int64]graph.Graph[string, string])

	md := mockData(1e3, 1e2)
	b.ResetTimer()

	nodeMap := make(map[int64]map[string]struct{})
	relationMap := make(map[int64]map[string]struct{})

	for i := 0; i < b.N; i++ {
		// 测试AddTimeRelation的性能
		for _, tc := range md {
			sources := make([]string, 0)
			for _, k := range []string{"bcs_cluster_id", "namespace", "pod", "container"} {
				sources = append(sources, fmt.Sprintf("%s=%s", k, tc.info[k]))
			}
			sourceKey := strings.Join(sources, ",")
			targets := make([]string, 0)
			for _, k := range []string{"bcs_cluster_id", "namespace", "pod"} {
				targets = append(targets, fmt.Sprintf("%s=%s", k, tc.info[k]))
			}
			targetKey := strings.Join(targets, ",")

			for _, t := range tc.time {
				if _, ok := relationMap[t]; !ok {
					relationMap[t] = make(map[string]struct{})
				}
				if _, ok := nodeMap[t]; !ok {
					nodeMap[t] = make(map[string]struct{})
				}
				if _, ok := tg[t]; !ok {
					tg[t] = graph.New(graph.StringHash, graph.Directed())
				}

				if _, ok := nodeMap[t][sourceKey]; !ok {
					tg[t].AddVertex(sourceKey)
					nodeMap[t][sourceKey] = struct{}{}
				}
				if _, ok := nodeMap[t][targetKey]; !ok {
					tg[t].AddVertex(targetKey)
					nodeMap[t][targetKey] = struct{}{}
				}
				if _, ok := relationMap[t][sourceKey]; !ok {
					tg[t].AddEdge(sourceKey, targetKey)
					nodeMap[t][sourceKey] = struct{}{}
				}
			}

		}
	}

	for t, g := range tg {
		num, _ := g.Size()
		fmt.Printf("时序边数: %d: %d\n", t, num)
	}
}

func BenchmarkGraphQuery_CreateGraphWithTimeRelation(b *testing.B) {
	b.ReportAllocs() // 报告内存分配

	// 预先生成测试数据
	ctx := metadata.InitHashID(context.Background())
	tg := NewTimeGraph()

	md := mockData(1e3, 1e2)
	b.ResetTimer()

	for i := 0; i < b.N; i++ {
		// 测试AddTimeRelation的性能
		for _, tc := range md {
			err := tg.AddTimeRelation(ctx, tc.source, tc.target, tc.info, tc.time...)
			if err != nil {
				b.Fatalf("AddTimeRelation failed: %v", err)
			}
		}
	}

	fmt.Println(tg.Stat())
}

// BenchmarkGraphQuery_AddTimeRelation 测试AddTimeRelation的性能
func BenchmarkGraphQuery_AddTimeRelation(b *testing.B) {
	b.ReportAllocs()

	ctx := metadata.InitHashID(context.Background())
	tg := NewTimeGraph()

	// 预先生成测试数据
	info := map[string]string{
		"namespace":      "blueking",
		"bcs_cluster_id": "BCS-K8S-00000",
		"pod":            "test-pod-123",
		"container":      "test-container",
	}
	timestamps := []int64{1763636985, 1763637285, 1763637585, 1763637885, 1763638185}

	b.ResetTimer()

	for i := 0; i < b.N; i++ {
		err := tg.AddTimeRelation(ctx, "pod", "container", info, timestamps...)
		if err != nil {
			b.Fatalf("AddTimeRelation failed: %v", err)
		}
	}
}

// BenchmarkNodeBuilder_GetID 测试NodeBuilder.GetID的性能
func BenchmarkNodeBuilder_GetID(b *testing.B) {
	b.ReportAllocs()

	nb := NewNodeBuilder(nil)
	info := map[string]string{
		"namespace":      "blueking",
		"bcs_cluster_id": "BCS-K8S-00000",
		"pod":            "test-pod-123",
	}

	b.ResetTimer()

	for i := 0; i < b.N; i++ {
		_, err := nb.GetID("pod", info)
		if err != nil {
			b.Fatalf("GetID failed: %v", err)
		}
	}
}

func TestMakeTimeGraph(t *testing.T) {
	tg := getTimeGrap()
	log.Infof(context.TODO(), "%s", tg.Stat())
}

func getTimeGrap() *TimeGraph {
	spaceUID := influxdb.SpaceUid
	start := time.Unix(1763636985, 0)
	end := time.Unix(1763640585, 0)
	step := time.Minute * 5
	matcher := map[string]string{
		"namespace": "blueking",
	}
	relations := []cmdb.Relation{
		{V: [2]cmdb.Resource{"pod", "container"}},
		{V: [2]cmdb.Resource{"node", "pod"}},
		{V: [2]cmdb.Resource{"node", "system"}},
	}

	ctx := metadata.InitHashID(context.Background())
	mock.Init()
	influxdb.MockSpaceRouter(ctx)

	mock.Vm.Set(map[string]any{
		`query_range:17636369851763640585300count by (bcs_cluster_id, container, namespace, pod) (count_over_time(a[5m]))`: `{"result":true,"message":"成功","code":"00","data":{"list":[{"status":"success","isPartial":false,"data":{"resultType":"matrix","result":[{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-513-hgh8l"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-514-bmr4h"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-516-zplkg"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-517-m69hs"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-523-hm6jx"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-543-zvmcn"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-544-cfxp4"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-545-bcqsm"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-546-ndvr5"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-557-bkj92"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-559-tcs9k"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-563-h655n"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-583-mxspg"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-c56d97548-2xzlz"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-c56d97548-58cw4"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-c56d97548-frcln"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-c56d97548-sqt75"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-153-927sh"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-158-htbkd"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"sync-apigw","namespace":"blueking","pod":"bk-datalink-unify-query-apigw-sync-159-q6pt6"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-6f57fbbb5f-4d485"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-6f57fbbb5f-grntp"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-6f57fbbb5f-l6qkb"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-6f57fbbb5f-sb6m4"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-api-7c4c9559c8-8g64x"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00003","container":"unify-query","namespace":"blueking","pod":"bk-datalink-unify-query-api-7c4c9559c8-plzlx"},"values":[[1763636985,"1"],[1763637285,"1"],[1763637585,"1"],[1763637885,"1"],[1763638185,"1"],[1763638485,"1"],[1763638785,"1"],[1763639085,"1"],[1763639385,"1"],[1763639685,"1"],[1763639985,"1"],[1763640285,"1"],[1763640585,"1"]]}]}}]}}`,
		`query_range:17636369851763640585300count by (bcs_cluster_id, namespace, node, pod) (count_over_time(a[5m]))`:      `{"result":true,"message":"成功","code":"00","data":{"list":[{"status":"success","isPartial":false,"data":{"resultType":"matrix","result":[{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.2","pod":"bk-datalink-unify-query-apigw-sync-583-mxspg"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.3","pod":"bk-datalink-unify-query-c56d97548-frcln"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.89","pod":"bk-datalink-unify-query-apigw-sync-544-cfxp4"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.204","pod":"bk-datalink-unify-query-apigw-sync-517-m69hs"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.211","pod":"bk-datalink-unify-query-apigw-sync-513-hgh8l"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.211","pod":"bk-datalink-unify-query-apigw-sync-514-bmr4h"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.168","pod":"bk-datalink-unify-query-c56d97548-2xzlz"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.111","pod":"bk-datalink-unify-query-c56d97548-58cw4"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.121","pod":"bk-datalink-unify-query-apigw-sync-559-tcs9k"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.50","pod":"bk-datalink-unify-query-apigw-sync-563-h655n"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.152","pod":"bk-datalink-unify-query-apigw-sync-543-zvmcn"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.152","pod":"bk-datalink-unify-query-apigw-sync-545-bcqsm"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.211","pod":"bk-datalink-unify-query-apigw-sync-523-hm6jx"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.68","pod":"bk-datalink-unify-query-apigw-sync-546-ndvr5"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.184","pod":"bk-datalink-unify-query-apigw-sync-516-zplkg"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.19","pod":"bk-datalink-unify-query-apigw-sync-557-bkj92"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","namespace":"blueking","node":"127.0.0.37","pod":"bk-datalink-unify-query-c56d97548-sqt75"},"values":[[1763707800,"1"],[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"]]}]}}]}}`,
		`query_range:17636369851763640585300count by (bcs_cluster_id, bk_target_ip, node) (count_over_time(a[5m]))`:        `{"result":true,"message":"成功","code":"00","data":{"list":[{"status":"success","isPartial":false,"data":{"resultType":"matrix","result":[{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.229","node":"master-127.0.0.229"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.41","node":"master-127.0.0.41"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.90","node":"master-127.0.0.90"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.188","node":"127.0.0.188"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.212","node":"127.0.0.212"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.218","node":"127.0.0.218"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.127","node":"127.0.0.127"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.25","node":"127.0.0.25"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.103","node":"127.0.0.103"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.125","node":"127.0.0.125"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.133","node":"127.0.0.133"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.2","node":"127.0.0.2"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.51","node":"127.0.0.51"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.61","node":"127.0.0.61"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.78","node":"127.0.0.78"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.82","node":"127.0.0.82"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.84","node":"127.0.0.84"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.94","node":"127.0.0.94"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.105","node":"127.0.0.105"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.118","node":"127.0.0.118"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.123","node":"127.0.0.123"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.126","node":"127.0.0.126"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.50","node":"127.0.0.50"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.53","node":"127.0.0.53"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.56","node":"127.0.0.56"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.61","node":"127.0.0.61"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.65","node":"127.0.0.65"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.83","node":"127.0.0.83"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.3","node":"127.0.0.3"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.89","node":"127.0.0.89"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.4","node":"127.0.0.4"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.55","node":"127.0.0.55"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.5","node":"127.0.0.5"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.204","node":"127.0.0.204"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.211","node":"127.0.0.211"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.212","node":"127.0.0.212"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.226","node":"127.0.0.226"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.212","node":"127.0.0.212"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.66","node":"127.0.0.66"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.88","node":"127.0.0.88"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.168","node":"127.0.0.168"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.225","node":"127.0.0.225"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.226","node":"127.0.0.226"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.111","node":"127.0.0.111"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.121","node":"127.0.0.121"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.50","node":"127.0.0.50"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.102","node":"127.0.0.102"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.152","node":"127.0.0.152"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.87","node":"127.0.0.87"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.78","node":"127.0.0.78"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.238","node":"127.0.0.238"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.171","node":"127.0.0.171"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.174","node":"127.0.0.174"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.211","node":"127.0.0.211"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.68","node":"127.0.0.68"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.207","node":"127.0.0.207"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.189","node":"127.0.0.189"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.69","node":"127.0.0.69"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.184","node":"127.0.0.184"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.19","node":"127.0.0.19"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.37","node":"127.0.0.37"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.75","node":"127.0.0.75"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.249","node":"127.0.0.249"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.215","node":"127.0.0.215"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.141","node":"127.0.0.141"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]},{"metric":{"bcs_cluster_id":"BCS-K8S-00000","bk_target_ip":"127.0.0.1","node":"127.0.0.1"},"values":[[1763708100,"1"],[1763708400,"1"],[1763708700,"1"],[1763709000,"1"],[1763709300,"1"],[1763709600,"1"],[1763709900,"1"],[1763710200,"1"],[1763710500,"1"],[1763710800,"1"],[1763711100,"1"],[1763711400,"1"],[1763711700,"1"]]}]}}]}}`,
	})

	tg := NewTimeGraph()

	ins := prometheus.GetTsDbInstance(ctx, &metadata.Query{
		StorageID:   metadata.VictoriaMetricsStorageType,
		StorageType: metadata.VictoriaMetricsStorageType,
	})

	for _, relation := range relations {
		ctx = metadata.InitHashID(ctx)

		queryTs, err := tg.MakeQueryTs(ctx, spaceUID, matcher, start, end, step, relation)
		if err != nil {
			log.Fatalf(ctx, "%s", err.Error())
		}

		queryRef, err := queryTs.ToQueryReference(ctx)
		if err != nil {
			log.Fatalf(ctx, "%s", err.Error())
		}
		metadata.SetExpand(ctx, query.ToVmExpand(ctx, queryRef))

		expr, err := queryTs.ToPromExpr(ctx, nil)
		if err != nil {
			log.Fatalf(ctx, "%s", err.Error())
		}
		stmt := expr.String()
		res, _, err := ins.DirectQueryRange(ctx, stmt, start, end, step)
		if err != nil {
			log.Fatalf(ctx, "%s", err.Error())
		}

		// 预分配内存，减少重复分配
		for _, series := range res {
			// 复用info map，避免重复分配
			info := make(map[string]string, len(series.Metric))
			for _, m := range series.Metric {
				info[m.Name] = m.Value
			}

			// 直接使用points的T值，避免额外的slice分配
			timestamps := make([]int64, len(series.Points))
			for i, point := range series.Points {
				timestamps[i] = point.T
			}

			source, target, _ := relation.Info()
			err = tg.AddTimeRelation(ctx, source, target, info, timestamps...)
			if err != nil {
				log.Fatalf(ctx, "%s", err.Error())
			}
		}
	}

	return tg
}

// BenchmarkGraphQuery_ComplexRelations_Comparison 测试复杂关系网络下的性能对比
func BenchmarkGraphQuery_ComplexRelations_Comparison(b *testing.B) {
	// 模拟真实生产环境中的多层拓扑关系
	var infos []map[string]string
	var timestamps []int64

	// 生成1000个不同的info
	for i := 0; i < 1000; i++ {
		infos = append(infos, map[string]string{
			"namespace":      fmt.Sprintf("blueking-%d", i),
			"bcs_cluster_id": fmt.Sprintf("BCS-K8S-%05d", i),
			"pod":            fmt.Sprintf("test-pod-%d", i),
			"container":      fmt.Sprintf("test-container-%d", i),
			"node":           fmt.Sprintf("node-%d", i%100),
			"service":        fmt.Sprintf("service-%d", i%50),
			"deployment":     fmt.Sprintf("deployment-%d", i%20),
			"replicaset":     fmt.Sprintf("replicaset-%d", i),
			"bk_target_ip":   fmt.Sprintf("192.168.%d.%d", i/256, i%256),
			"zone":           fmt.Sprintf("zone-%d", i%10),
			"region":         fmt.Sprintf("region-%d", i%5),
		})
	}

	// 生成50个时间戳
	baseTime := int64(1763636985)
	for i := 0; i < 50; i++ {
		timestamps = append(timestamps, baseTime+int64(i*300))
	}

	// 定义多层拓扑关系
	relations := []struct {
		source string
		target string
	}{
		{"container", "pod"},
		{"pod", "node"},
		{"pod", "service"},
		{"service", "deployment"},
		{"deployment", "replicaset"},
		{"node", "zone"},
		{"zone", "region"},
	}

	b.Run("WithSharing_ComplexRelations", func(b *testing.B) {
		b.ReportAllocs()
		ctx := metadata.InitHashID(context.Background())

		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			tg := NewTimeGraph()
			for _, info := range infos {
				for _, rel := range relations {
					err := tg.AddTimeRelation(ctx, cmdb.Resource(rel.source), cmdb.Resource(rel.target), info, timestamps...)
					if err != nil {
						b.Fatalf("AddTimeRelation failed: %v", err)
					}
				}
			}
		}
	})

	b.Run("WithoutSharing_ComplexRelations", func(b *testing.B) {
		b.ReportAllocs()
		ctx := metadata.InitHashID(context.Background())

		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			tg := NewTimeGraphWithoutSharing()
			for _, info := range infos {
				for _, rel := range relations {
					err := tg.AddTimeRelation(ctx, cmdb.Resource(rel.source), cmdb.Resource(rel.target), info, timestamps...)
					if err != nil {
						b.Fatalf("AddTimeRelation failed: %v", err)
					}
				}
			}
		}
	})
}

// BenchmarkGraphQuery_MemoryPeak_Comparison 测试内存峰值使用情况对比
func BenchmarkGraphQuery_MemoryPeak_Comparison(b *testing.B) {
	// 使用runtime包来测量内存峰值
	b.Run("WithSharing_MemoryPeak", func(b *testing.B) {
		b.ReportAllocs()
		ctx := metadata.InitHashID(context.Background())

		var m1, m2 runtime.MemStats
		runtime.ReadMemStats(&m1)

		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			tg := NewTimeGraph()

			// 添加大量复杂数据
			for j := 0; j < 10000; j++ {
				info := map[string]string{
					"namespace":      fmt.Sprintf("blueking-%d", j),
					"bcs_cluster_id": fmt.Sprintf("BCS-K8S-%05d", j),
					"pod":            fmt.Sprintf("test-pod-%d", j),
					"container":      fmt.Sprintf("test-container-%d", j),
					"node":           fmt.Sprintf("node-%d", j%100),
					"service":        fmt.Sprintf("service-%d", j%50),
					"bk_target_ip":   fmt.Sprintf("192.168.%d.%d", j/256, j%256),
					"zone":           fmt.Sprintf("zone-%d", j%10),
					"region":         fmt.Sprintf("region-%d", j%5),
					"deployment":     fmt.Sprintf("deployment-%d", j%20),
					"replicaset":     fmt.Sprintf("replicaset-%d", j),
				}

				// 添加多层关系
				tg.AddTimeRelation(ctx, "container", "pod", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "pod", "node", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "pod", "service", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "service", "deployment", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "deployment", "replicaset", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "node", "zone", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "zone", "region", info, 1763636985, 1763637285, 1763637585)
			}
		}

		runtime.ReadMemStats(&m2)
		b.ReportMetric(float64(m2.Alloc-m1.Alloc)/1024/1024, "MB_peak")
	})

	b.Run("WithoutSharing_MemoryPeak", func(b *testing.B) {
		b.ReportAllocs()
		ctx := metadata.InitHashID(context.Background())

		var m1, m2 runtime.MemStats
		runtime.ReadMemStats(&m1)

		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			tg := NewTimeGraphWithoutSharing()

			// 添加相同的大量复杂数据
			for j := 0; j < 10000; j++ {
				info := map[string]string{
					"namespace":      fmt.Sprintf("blueking-%d", j),
					"bcs_cluster_id": fmt.Sprintf("BCS-K8S-%05d", j),
					"pod":            fmt.Sprintf("test-pod-%d", j),
					"container":      fmt.Sprintf("test-container-%d", j),
					"node":           fmt.Sprintf("node-%d", j%100),
					"service":        fmt.Sprintf("service-%d", j%50),
					"bk_target_ip":   fmt.Sprintf("192.168.%d.%d", j/256, j%256),
					"zone":           fmt.Sprintf("zone-%d", j%10),
					"region":         fmt.Sprintf("region-%d", j%5),
					"deployment":     fmt.Sprintf("deployment-%d", j%20),
					"replicaset":     fmt.Sprintf("replicaset-%d", j),
				}

				// 添加多层关系
				tg.AddTimeRelation(ctx, "container", "pod", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "pod", "node", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "pod", "service", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "service", "deployment", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "deployment", "replicaset", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "node", "zone", info, 1763636985, 1763637285, 1763637585)
				tg.AddTimeRelation(ctx, "zone", "region", info, 1763636985, 1763637285, 1763637585)
			}
		}

		runtime.ReadMemStats(&m2)
		b.ReportMetric(float64(m2.Alloc-m1.Alloc)/1024/1024, "MB_peak")
	})
}

func TestTimeGraph_MakeQueryTs(t *testing.T) {
	spaceUID := "test-space"

	testCases := map[string]struct {
		labels    map[string]string
		relations []cmdb.Relation
		expected  []string
	}{
		"test create query ts with relations": {
			labels: map[string]string{
				"namespace": "blueking",
			},
			relations: []cmdb.Relation{
				{V: [2]cmdb.Resource{"pod", "container"}},
				{V: [2]cmdb.Resource{"node", "pod"}},
				{V: [2]cmdb.Resource{"node", "system"}},
			},
			expected: []string{
				`count by (bcs_cluster_id, container, namespace, pod) (count_over_time(bkmonitor:container_with_pod_relation{bcs_cluster_id!="",container!="",namespace="blueking",pod!=""}[5m]))`,
				`count by (bcs_cluster_id, namespace, node, pod) (count_over_time(bkmonitor:node_with_pod_relation{bcs_cluster_id!="",namespace="blueking",node!="",pod!=""}[5m]))`,
				`count by (bcs_cluster_id, bk_target_ip, node) (count_over_time(bkmonitor:node_with_system_relation{bcs_cluster_id!="",bk_target_ip!="",node!=""}[5m]))`,
			},
		},
	}

	start := time.Unix(1763636985, 0)
	end := time.Unix(1763640585, 0)
	step := time.Minute * 5

	ctx := metadata.InitHashID(context.Background())
	tg := NewTimeGraph()

	for name, c := range testCases {
		t.Run(name, func(t *testing.T) {
			for i, relation := range c.relations {
				queryTs, err := tg.MakeQueryTs(ctx, spaceUID, c.labels, start, end, step, relation)
				assert.NoError(t, err)

				promql, err := queryTs.ToPromQL(ctx)
				assert.NoError(t, err)
				assert.Equal(t, c.expected[i], promql)
			}
		})
	}
}

func TestTimeGraph_AddTimeRelation(t *testing.T) {
	ctx := context.Background()
	tg := NewTimeGraph()

	t.Run("正常添加时间关系", func(t *testing.T) {
		info := cmdb.Matcher{
			"namespace":      "blueking",
			"bcs_cluster_id": "BCS-K8S-00000",
			"pod":            "test-pod",
			"container":      "test-container",
		}
		timestamps := []int64{1763636985, 1763637285, 1763637585}

		err := tg.AddTimeRelation(ctx, "pod", "container", info, timestamps...)
		assert.NoError(t, err)

		nodes := tg.GetNodesByResourceType("pod")
		containers := tg.GetNodesByResourceType("container")

		// 验证节点信息 - pod 需要 bcs_cluster_id, namespace, pod
		expectedPodInfo := cmdb.Matcher{
			"bcs_cluster_id": "BCS-K8S-00000",
			"namespace":      "blueking",
			"pod":            "test-pod",
		}
		// container 需要 bcs_cluster_id, namespace, pod, container
		expectedContainerInfo := cmdb.Matcher{
			"bcs_cluster_id": "BCS-K8S-00000",
			"namespace":      "blueking",
			"pod":            "test-pod",
			"container":      "test-container",
		}

		assert.Contains(t, nodes, expectedPodInfo)
		assert.Contains(t, containers, expectedContainerInfo)

		// 验证时间图状态
		stat := tg.Stat()
		assert.Contains(t, stat, "节点总数: 2")
		assert.Contains(t, stat, "时序边数: 1763636985: 1")
		assert.Contains(t, stat, "时序边数: 1763637285: 1")
		assert.Contains(t, stat, "时序边数: 1763637585: 1")
	})

	t.Run("info为空时直接返回", func(t *testing.T) {
		emptyInfo := map[string]string{}
		timestamps := []int64{1763636985}

		err := tg.AddTimeRelation(ctx, "node", "pod", emptyInfo, timestamps...)
		assert.NoError(t, err)

		// 验证没有添加任何关系
		stat := tg.Stat()
		// 应该只包含之前测试添加的节点和边
		assert.Contains(t, stat, "节点总数: 2")
	})

	t.Run("边已存在的情况", func(t *testing.T) {
		info := map[string]string{
			"bcs_cluster_id": "BCS-K8S-00000",
			"node":           "test-node",
			"bk_target_ip":   "127.0.0.100", // system 需要的索引
		}
		timestamps := []int64{1763636985} // 使用已存在的时间戳

		// 第一次添加
		err := tg.AddTimeRelation(ctx, "node", "system", info, timestamps...)
		assert.NoError(t, err)

		// 第二次添加相同的边
		err = tg.AddTimeRelation(ctx, "node", "system", info, timestamps...)
		assert.NoError(t, err) // 应该成功，边已存在时不会报错

		stat := tg.Stat()
		// 由于节点共享，实际节点数可能不同，只要包含节点总数即可
		assert.Contains(t, stat, "节点总数:")
	})

	t.Run("多个时间戳的情况", func(t *testing.T) {
		info := map[string]string{
			"namespace":      "test",
			"bcs_cluster_id": "BCS-K8S-00001",
			"service":        "test-service",
			"pod":            "test-pod-2",
		}
		// 添加多个连续时间戳
		timestamps := make([]int64, 10)
		for i := range timestamps {
			timestamps[i] = 1763638000 + int64(i*300)
		}

		err := tg.AddTimeRelation(ctx, "service", "pod", info, timestamps...)
		assert.NoError(t, err)

		stat := tg.Stat()
		// 验证所有时间戳都被添加
		for _, ts := range timestamps {
			assert.Contains(t, stat, fmt.Sprintf("时序边数: %d: 1", ts))
		}
	})

	t.Run("并发添加关系", func(t *testing.T) {
		var wg sync.WaitGroup
		errors := make(chan error, 10)

		for i := 0; i < 10; i++ {
			wg.Add(1)
			go func(index int) {
				defer wg.Done()
				info := map[string]string{
					"bcs_cluster_id": fmt.Sprintf("BCS-K8S-%05d", index),
					"node":           fmt.Sprintf("node-%d", index),
					"namespace":      fmt.Sprintf("namespace-%d", index),
					"pod":            fmt.Sprintf("pod-%d", index),
				}
				timestamps := []int64{1763639000 + int64(index)}

				err := tg.AddTimeRelation(ctx, "node", "pod", info, timestamps...)
				if err != nil {
					errors <- err
				}
			}(i)
		}

		wg.Wait()
		close(errors)

		// 检查是否有错误发生
		for err := range errors {
			assert.NoError(t, err)
		}

		// 验证所有关系都被正确添加
		// 注意：由于节点共享机制，相同节点信息会被去重
		// 初始有 pod, container (2个节点)，然后添加了10个不同的 node-pod 关系
		// 每个关系需要 node 和 pod 节点，但由于节点去重，实际节点数取决于唯一节点信息数量
		stat := tg.Stat()
		// 至少应该有初始的2个节点 + 新增的节点
		assert.Contains(t, stat, "节点总数:")
	})

	t.Run("不同资源类型的关系", func(t *testing.T) {
		testCases := []struct {
			name     string
			source   cmdb.Resource
			target   cmdb.Resource
			info     map[string]string
			expected string
		}{
			{
				name:   "pod到container关系",
				source: "pod",
				target: "container",
				info: map[string]string{
					"bcs_cluster_id": "BCS-K8S-00002",
					"namespace":      "app1",
					"pod":            "app1-pod",
					"container":      "app1-container",
				},
			},
			{
				name:   "node到pod关系",
				source: "node",
				target: "pod",
				info: map[string]string{
					"bcs_cluster_id": "BCS-K8S-00002",
					"node":           "test-node-1",
					"namespace":      "app1",
					"pod":            "app1-pod",
				},
			},
			{
				name:   "service到pod关系",
				source: "service",
				target: "pod",
				info: map[string]string{
					"bcs_cluster_id": "BCS-K8S-00002",
					"namespace":      "app1",
					"service":        "web-service",
					"pod":            "app1-pod",
				},
			},
		}

		for _, tc := range testCases {
			t.Run(tc.name, func(t *testing.T) {
				// 使用不同的时间戳，避免与之前测试冲突
				timestamps := []int64{1763650000 + int64(len(testCases))}
				err := tg.AddTimeRelation(ctx, tc.source, tc.target, tc.info, timestamps...)
				assert.NoError(t, err)

				// 验证关系被正确添加
				stat := tg.Stat()
				// 由于可能有其他测试添加了相同时间戳的边，我们只验证时间戳存在即可
				assert.Contains(t, stat, fmt.Sprintf("时序边数: %d:", timestamps[0]))
			})
		}
	})
}

// TimeGraphWithoutSharing 不使用共享Node设计的对比版本
type TimeGraphWithoutSharing struct {
	lock      sync.RWMutex
	timeGraph map[int64]graph.Graph[string, string] // 直接存储字符串节点，不使用共享ID
}

func NewTimeGraphWithoutSharing() *TimeGraphWithoutSharing {
	return &TimeGraphWithoutSharing{
		timeGraph: make(map[int64]graph.Graph[string, string]),
	}
}

func (q *TimeGraphWithoutSharing) addNode(ctx context.Context, timestamp int64, nodes ...string) error {
	if q.timeGraph[timestamp] == nil {
		q.timeGraph[timestamp] = graph.New(func(s string) string {
			return s
		}, graph.Directed())
	}

	for _, node := range nodes {
		err := q.timeGraph[timestamp].AddVertex(node)
		if err != nil && !errors.Is(err, graph.ErrVertexAlreadyExists) {
			return err
		}
	}

	return nil
}

func (q *TimeGraphWithoutSharing) AddTimeRelation(ctx context.Context, source, target cmdb.Resource, info cmdb.Matcher, timestamps ...int64) error {
	if len(info) == 0 {
		return nil
	}

	// 直接使用资源类型和信息的字符串组合作为节点ID
	sourceNode := fmt.Sprintf("%s:%v", source, info)
	targetNode := fmt.Sprintf("%s:%v", target, info)

	q.lock.Lock()
	defer q.lock.Unlock()

	for _, timestamp := range timestamps {
		err := q.addNode(ctx, timestamp, sourceNode, targetNode)
		if err != nil {
			return err
		}

		err = q.timeGraph[timestamp].AddEdge(sourceNode, targetNode)
		if err != nil && !errors.Is(err, graph.ErrEdgeAlreadyExists) {
			return err
		}
	}

	return nil
}

// BenchmarkGraphQuery_AddTimeRelation_WithoutSharing 测试不使用共享Node设计的AddTimeRelation性能
func BenchmarkGraphQuery_AddTimeRelation_WithoutSharing(b *testing.B) {
	b.ReportAllocs()

	ctx := metadata.InitHashID(context.Background())
	tg := NewTimeGraphWithoutSharing()

	// 使用相同的数据进行对比
	info := map[string]string{
		"namespace":      "blueking",
		"bcs_cluster_id": "BCS-K8S-00000",
		"pod":            "test-pod-123",
		"container":      "test-container",
	}
	timestamps := []int64{1763636985, 1763637285, 1763637585, 1763637885, 1763638185}

	b.ResetTimer()

	for i := 0; i < b.N; i++ {
		err := tg.AddTimeRelation(ctx, "pod", "container", info, timestamps...)
		if err != nil {
			b.Fatalf("AddTimeRelation failed: %v", err)
		}
	}
}

// BenchmarkGraphQuery_AddTimeRelation_Comparison 对比两种实现的性能差异
func BenchmarkGraphQuery_AddTimeRelation_Comparison(b *testing.B) {
	// 测试共享Node设计
	b.Run("WithSharing", func(b *testing.B) {
		b.ReportAllocs()
		ctx := metadata.InitHashID(context.Background())
		tg := NewTimeGraph()

		info := map[string]string{
			"namespace":      "blueking",
			"bcs_cluster_id": "BCS-K8S-00000",
			"pod":            "test-pod-123",
			"container":      "test-container",
		}
		timestamps := []int64{1763636985, 1763637285, 1763637585, 1763637885, 1763638185}

		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			err := tg.AddTimeRelation(ctx, "pod", "container", info, timestamps...)
			if err != nil {
				b.Fatalf("AddTimeRelation failed: %v", err)
			}
		}
	})

	// 测试不使用共享Node设计
	b.Run("WithoutSharing", func(b *testing.B) {
		b.ReportAllocs()
		ctx := metadata.InitHashID(context.Background())
		tg := NewTimeGraphWithoutSharing()

		info := map[string]string{
			"namespace":      "blueking",
			"bcs_cluster_id": "BCS-K8S-00000",
			"pod":            "test-pod-123",
			"container":      "test-container",
		}
		timestamps := []int64{1763636985, 1763637285, 1763637585, 1763637885, 1763638185}

		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			err := tg.AddTimeRelation(ctx, "pod", "container", info, timestamps...)
			if err != nil {
				b.Fatalf("AddTimeRelation failed: %v", err)
			}
		}
	})
}

// BenchmarkGraphQuery_ExtremeScale_Comparison 测试超大规模数据下的内存使用对比（几百兆级别）
func BenchmarkGraphQuery_ExtremeScale_Comparison(b *testing.B) {
	// 生成几百兆级别的超大规模测试数据
	var infos []map[string]string
	var timestamps []int64

	// 生成5000个不同的info（模拟真实生产环境规模）
	for i := 0; i < 5000; i++ {
		info := map[string]string{
			"namespace":      fmt.Sprintf("blueking-%d", i),
			"bcs_cluster_id": fmt.Sprintf("BCS-K8S-%05d", i),
			"pod":            fmt.Sprintf("test-pod-%d", i),
			"container":      fmt.Sprintf("test-container-%d", i),
			"bk_target_ip":   fmt.Sprintf("192.168.%d.%d", i/256, i%256),
			"service_name":   fmt.Sprintf("service-%d", i),
			"deployment":     fmt.Sprintf("deployment-%d", i),
			"replicaset":     fmt.Sprintf("replicaset-%d", i),
			"node_name":      fmt.Sprintf("node-%d", i),
			"zone":           fmt.Sprintf("zone-%d", i%10),
			"region":         fmt.Sprintf("region-%d", i%5),
			"environment":    "production",
			"team":           fmt.Sprintf("team-%d", i%20),
			"app_id":         fmt.Sprintf("app-%d", i),
			"module_name":    fmt.Sprintf("module-%d", i),
			"business_id":    fmt.Sprintf("biz-%d", i%100),
			"instance_id":    fmt.Sprintf("instance-%d", i),
			"workload_type":  "deployment",
			"cpu_request":    "500m",
			"memory_limit":   "1Gi",
		}

		// 为每个info添加更多随机标签，增加数据复杂度
		for j := 0; j < 10; j++ {
			info[fmt.Sprintf("custom_label_%d", j)] = fmt.Sprintf("value_%d_%d", i, j)
		}

		infos = append(infos, info)
	}

	// 生成500个时间戳（模拟长时间范围监控）
	baseTime := int64(1763636985)
	for i := 0; i < 500; i++ {
		timestamps = append(timestamps, baseTime+int64(i*300))
	}

	b.Run("WithSharing_ExtremeScale", func(b *testing.B) {
		b.ReportAllocs()
		ctx := metadata.InitHashID(context.Background())

		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			tg := NewTimeGraph()
			for _, info := range infos {
				err := tg.AddTimeRelation(ctx, "pod", "container", info, timestamps...)
				if err != nil {
					b.Fatalf("AddTimeRelation failed: %v", err)
				}
			}
		}
	})

	b.Run("WithoutSharing_ExtremeScale", func(b *testing.B) {
		b.ReportAllocs()
		ctx := metadata.InitHashID(context.Background())

		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			tg := NewTimeGraphWithoutSharing()
			for _, info := range infos {
				err := tg.AddTimeRelation(ctx, "pod", "container", info, timestamps...)
				if err != nil {
					b.Fatalf("AddTimeRelation failed: %v", err)
				}
			}
		}
	})
}

// BenchmarkGraphQuery_MemoryUsage_Comparison 测试大规模数据下的内存使用对比
func BenchmarkGraphQuery_MemoryUsage_Comparison(b *testing.B) {
	// 生成几百兆级别的大规模测试数据
	var infos []map[string]string
	var timestamps []int64

	// 生成1000个不同的info（增加10倍数据量）
	for i := 0; i < 1000; i++ {
		infos = append(infos, map[string]string{
			"namespace":      fmt.Sprintf("blueking-%d", i),
			"bcs_cluster_id": fmt.Sprintf("BCS-K8S-%05d", i),
			"pod":            fmt.Sprintf("test-pod-%d", i),
			"container":      fmt.Sprintf("test-container-%d", i),
			// 增加更多复杂字段
			"bk_target_ip": fmt.Sprintf("192.168.%d.%d", i/256, i%256),
			"service_name": fmt.Sprintf("service-%d", i),
			"deployment":   fmt.Sprintf("deployment-%d", i),
			"replicaset":   fmt.Sprintf("replicaset-%d", i),
			"node_name":    fmt.Sprintf("node-%d", i),
			"zone":         fmt.Sprintf("zone-%d", i%10),
			"region":       fmt.Sprintf("region-%d", i%5),
			"environment":  "production",
			"team":         fmt.Sprintf("team-%d", i%20),
		})
	}

	// 生成100个时间戳（增加10倍时间范围）
	baseTime := int64(1763636985)
	for i := 0; i < 100; i++ {
		timestamps = append(timestamps, baseTime+int64(i*300))
	}

	b.Run("WithSharing_LargeScale", func(b *testing.B) {
		b.ReportAllocs()
		ctx := metadata.InitHashID(context.Background())

		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			tg := NewTimeGraph()
			for _, info := range infos {
				err := tg.AddTimeRelation(ctx, "pod", "container", info, timestamps...)
				if err != nil {
					b.Fatalf("AddTimeRelation failed: %v", err)
				}
			}
		}
	})

	b.Run("WithoutSharing_LargeScale", func(b *testing.B) {
		b.ReportAllocs()
		ctx := metadata.InitHashID(context.Background())

		b.ResetTimer()
		for i := 0; i < b.N; i++ {
			tg := NewTimeGraphWithoutSharing()
			for _, info := range infos {
				err := tg.AddTimeRelation(ctx, "pod", "container", info, timestamps...)
				if err != nil {
					b.Fatalf("AddTimeRelation failed: %v", err)
				}
			}
		}
	})
}

func TestTimeGraph_FindPaths(t *testing.T) {
	ctx := metadata.InitHashID(context.Background())
	tg := NewTimeGraph()

	// 准备测试数据：构建一个简单的拓扑关系
	// pod -> node -> system
	// 添加 pod 到 node 的关系
	podToNodeInfo := map[string]string{
		"namespace":      "blueking",
		"bcs_cluster_id": "BCS-K8S-00001",
		"pod":            "test-pod-1",
		"node":           "127.0.0.1",
	}
	timestamps1 := []int64{1763636985, 1763637285}

	err := tg.AddTimeRelation(ctx, "pod", "node", podToNodeInfo, timestamps1...)
	assert.NoError(t, err)

	// 添加 node 到 system 的关系
	nodeToSystemInfo := map[string]string{
		"bcs_cluster_id": "BCS-K8S-00001",
		"node":           "127.0.0.1",
		"bk_target_ip":   "127.0.0.1",
	}
	timestamps2 := []int64{1763636985, 1763637285}

	err = tg.AddTimeRelation(ctx, "node", "system", nodeToSystemInfo, timestamps2...)
	assert.NoError(t, err)

	t.Run("基本功能：找到最短路径", func(t *testing.T) {
		partialMatcher := cmdb.Matcher{
			"namespace": "blueking",
			"pod":       "test-pod-1",
		}

		path := []cmdb.Resource{"pod", "node", "system"}
		results, err := tg.FindPaths(ctx, path, partialMatcher)
		assert.NoError(t, err)
		assert.NotEmpty(t, results)

		// 验证结果
		for _, result := range results {
			assert.Equal(t, cmdb.Resource("system"), result.TargetType)
			assert.Greater(t, len(result.Path), 0)
			assert.Contains(t, []int64{1763636985, 1763637285}, result.Timestamp)
			// 验证路径第一个节点是 pod，最后一个节点是 system
			if len(result.Path) > 0 {
				assert.Equal(t, cmdb.Resource("pod"), result.Path[0].ResourceType)
				assert.NotEmpty(t, result.Path[0].Dimensions["pod"])
				assert.Equal(t, cmdb.Resource("system"), result.Path[len(result.Path)-1].ResourceType)
			}
		}
	})

	t.Run("多个时间戳的情况", func(t *testing.T) {
		partialMatcher := cmdb.Matcher{
			"namespace": "blueking",
			"pod":       "test-pod-1",
		}

		path := []cmdb.Resource{"pod", "node", "system"}
		results, err := tg.FindPaths(ctx, path, partialMatcher)
		assert.NoError(t, err)

		// 应该为每个时间戳返回结果
		timestampSet := make(map[int64]bool)
		for _, result := range results {
			timestampSet[result.Timestamp] = true
		}
		assert.Equal(t, 2, len(timestampSet))
		assert.True(t, timestampSet[1763636985])
		assert.True(t, timestampSet[1763637285])
	})

	t.Run("部分匹配条件", func(t *testing.T) {
		// 只使用 namespace 进行部分匹配
		partialMatcher := cmdb.Matcher{
			"namespace": "blueking",
		}

		path := []cmdb.Resource{"pod", "node", "system"}
		results, err := tg.FindPaths(ctx, path, partialMatcher)
		assert.NoError(t, err)
		assert.NotEmpty(t, results)

		// 验证所有结果的源节点都满足部分匹配条件
		for _, result := range results {
			if len(result.Path) > 0 {
				assert.Equal(t, "blueking", result.Path[0].Dimensions["namespace"])
			}
		}
	})

	t.Run("空路径", func(t *testing.T) {
		partialMatcher := cmdb.Matcher{
			"namespace": "blueking",
			"pod":       "test-pod-1",
		}

		path := []cmdb.Resource{}
		results, err := tg.FindPaths(ctx, path, partialMatcher)
		assert.NoError(t, err)
		assert.Nil(t, results)
	})

	t.Run("找不到源节点", func(t *testing.T) {
		partialMatcher := cmdb.Matcher{
			"namespace": "nonexistent",
			"pod":       "nonexistent-pod",
		}

		path := []cmdb.Resource{"pod", "node", "system"}
		results, err := tg.FindPaths(ctx, path, partialMatcher)
		assert.NoError(t, err)
		assert.Nil(t, results)
	})

	t.Run("空部分匹配条件", func(t *testing.T) {
		// 空匹配条件应该返回该资源类型的所有节点
		partialMatcher := cmdb.Matcher{}

		path := []cmdb.Resource{"pod", "node", "system"}
		results, err := tg.FindPaths(ctx, path, partialMatcher)
		assert.NoError(t, err)
		// 如果存在 pod 节点，应该能找到路径
		if len(results) > 0 {
			for _, result := range results {
				assert.Equal(t, cmdb.Resource("system"), result.TargetType)
			}
		}
	})

	t.Run("路径长度验证", func(t *testing.T) {
		partialMatcher := cmdb.Matcher{
			"namespace": "blueking",
			"pod":       "test-pod-1",
		}

		path := []cmdb.Resource{"pod", "node", "system"}
		results, err := tg.FindPaths(ctx, path, partialMatcher)
		assert.NoError(t, err)
		assert.NotEmpty(t, results)

		// pod -> node -> system，路径应该包含 3 个节点：pod, node, system
		for _, result := range results {
			assert.Equal(t, 3, len(result.Path)) // 路径包含 3 个节点：pod, node, system
			// 验证路径中的资源类型顺序
			if len(result.Path) >= 3 {
				assert.Equal(t, cmdb.Resource("pod"), result.Path[0].ResourceType)
				assert.Equal(t, cmdb.Resource("node"), result.Path[1].ResourceType)
				assert.Equal(t, cmdb.Resource("system"), result.Path[2].ResourceType)
			}
		}
	})

	t.Run("路径节点顺序验证", func(t *testing.T) {
		partialMatcher := cmdb.Matcher{
			"namespace": "blueking",
			"pod":       "test-pod-1",
		}

		path := []cmdb.Resource{"pod", "node", "system"}
		results, err := tg.FindPaths(ctx, path, partialMatcher)
		assert.NoError(t, err)
		assert.NotEmpty(t, results)

		// 验证路径的第一个节点是源节点（pod），最后一个节点是目标节点（system）
		for _, result := range results {
			assert.Greater(t, len(result.Path), 0)
			// 验证第一个节点是 pod
			assert.Equal(t, cmdb.Resource("pod"), result.Path[0].ResourceType)
			// 验证最后一个节点是 system
			assert.Equal(t, cmdb.Resource("system"), result.Path[len(result.Path)-1].ResourceType)
			// 验证路径中每个节点都有维度信息
			for _, node := range result.Path {
				assert.NotEmpty(t, node.Dimensions)
			}
		}
	})

	t.Run("多个源节点的情况", func(t *testing.T) {
		// 添加另一个 pod
		anotherPodInfo := map[string]string{
			"namespace":      "blueking",
			"bcs_cluster_id": "BCS-K8S-00001",
			"pod":            "test-pod-2",
			"node":           "127.0.0.2",
		}
		err := tg.AddTimeRelation(ctx, "pod", "node", anotherPodInfo, timestamps1...)
		assert.NoError(t, err)

		// 为这个 node 添加到 system 的关系
		anotherNodeToSystemInfo := map[string]string{
			"bcs_cluster_id": "BCS-K8S-00001",
			"node":           "127.0.0.2",
			"bk_target_ip":   "127.0.0.2",
		}
		err = tg.AddTimeRelation(ctx, "node", "system", anotherNodeToSystemInfo, timestamps1...)
		assert.NoError(t, err)

		// 使用部分匹配，应该能找到多个源节点
		partialMatcher := cmdb.Matcher{
			"namespace": "blueking",
		}

		path := []cmdb.Resource{"pod", "node", "system"}
		results, err := tg.FindPaths(ctx, path, partialMatcher)
		assert.NoError(t, err)
		assert.NotEmpty(t, results)

		// 验证结果包含多个源节点（通过路径第一个节点的维度信息区分）
		sourcePods := make(map[string]bool)
		for _, result := range results {
			if len(result.Path) > 0 {
				podName := result.Path[0].Dimensions["pod"]
				if podName != "" {
					sourcePods[podName] = true
				}
			}
		}
		assert.GreaterOrEqual(t, len(sourcePods), 1)
	})

	t.Run("结果按时间戳排序", func(t *testing.T) {
		partialMatcher := cmdb.Matcher{
			"namespace": "blueking",
			"pod":       "test-pod-1",
		}

		path := []cmdb.Resource{"pod", "node", "system"}
		results, err := tg.FindPaths(ctx, path, partialMatcher)
		assert.NoError(t, err)
		assert.NotEmpty(t, results)

		// 验证结果按时间戳排序
		for i := 1; i < len(results); i++ {
			assert.LessOrEqual(t, results[i-1].Timestamp, results[i].Timestamp)
		}
	})
}
